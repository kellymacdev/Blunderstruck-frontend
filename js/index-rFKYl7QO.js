(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))s(l);new MutationObserver(l=>{for(const c of l)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function t(l){const c={};return l.integrity&&(c.integrity=l.integrity),l.referrerPolicy&&(c.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?c.credentials="include":l.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(l){if(l.ep)return;l.ep=!0;const c=t(l);fetch(l.href,c)}})();function Fn(a){return a!==null?{comment:a,variations:[]}:{variations:[]}}function qn(a,n,t,s,l){const c={move:a,variations:l};return n&&(c.suffix=n),t&&(c.nag=t),s!==null&&(c.comment=s),c}function Bn(...a){const[n,...t]=a;let s=n;for(const l of t)l!==null&&(s.variations=[l,...l.variations],l.variations=[],s=l);return n}function Kn(a,n){if(n.marker&&n.marker.comment){let t=n.root;for(;;){const s=t.variations[0];if(!s){t.comment=n.marker.comment;break}t=s}}return{headers:a,root:n.root,result:(n.marker&&n.marker.result)??void 0}}function jn(a,n){function t(){this.constructor=a}t.prototype=n.prototype,a.prototype=new t}function Ze(a,n,t,s){var l=Error.call(this,a);return Object.setPrototypeOf&&Object.setPrototypeOf(l,Ze.prototype),l.expected=n,l.found=t,l.location=s,l.name="SyntaxError",l}jn(Ze,Error);function dn(a,n,t){return t=t||" ",a.length>n?a:(n-=a.length,t+=t.repeat(n),a+t.slice(0,n))}Ze.prototype.format=function(a){var n="Error: "+this.message;if(this.location){var t=null,s;for(s=0;s<a.length;s++)if(a[s].source===this.location.source){t=a[s].text.split(/\r\n|\n|\r/g);break}var l=this.location.start,c=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(l):l,d=this.location.source+":"+c.line+":"+c.column;if(t){var u=this.location.end,_=dn("",c.line.toString().length," "),w=t[l.line-1],i=l.line===u.line?u.column:w.length+1,T=i-l.column||1;n+=`
 --> `+d+`
`+_+` |
`+c.line+" | "+w+`
`+_+" | "+dn("",l.column-1," ")+dn("",T,"^")}else n+=`
 at `+d}return n};Ze.buildMessage=function(a,n){var t={literal:function(w){return'"'+l(w.text)+'"'},class:function(w){var i=w.parts.map(function(T){return Array.isArray(T)?c(T[0])+"-"+c(T[1]):c(T)});return"["+(w.inverted?"^":"")+i.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(w){return w.description}};function s(w){return w.charCodeAt(0).toString(16).toUpperCase()}function l(w){return w.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(i){return"\\x0"+s(i)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(i){return"\\x"+s(i)})}function c(w){return w.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(i){return"\\x0"+s(i)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(i){return"\\x"+s(i)})}function d(w){return t[w.type](w)}function u(w){var i=w.map(d),T,E;if(i.sort(),i.length>0){for(T=1,E=1;T<i.length;T++)i[T-1]!==i[T]&&(i[E]=i[T],E++);i.length=E}switch(i.length){case 1:return i[0];case 2:return i[0]+" or "+i[1];default:return i.slice(0,-1).join(", ")+", or "+i[i.length-1]}}function _(w){return w?'"'+l(w)+'"':"end of input"}return"Expected "+u(a)+" but "+_(n)+" found."};function Un(a,n){n=n!==void 0?n:{};var t={},s=n.grammarSource,l={pgn:ut},c=ut,d="[",u='"',_="]",w=".",i="O-O-O",T="O-O",E="0-0-0",S="0-0",D="$",R="{",H="}",W=";",N="(",z=")",X="1-0",M="0-1",J="1/2-1/2",vt="*",me=/^[a-zA-Z]/,we=/^[^"]/,fe=/^[0-9]/,_e=/^[.]/,Xe=/^[a-zA-Z1-8\-=]/,yt=/^[+#]/,U=/^[!?]/,xe=/^[^}]/,Ee=/^[^\r\n]/,ve=/^[ \t\r\n]/,j=re("tag pair"),bt=Y("[",!1),je=Y('"',!1),Ie=Y("]",!1),tn=re("tag name"),Ue=le([["a","z"],["A","Z"]],!1,!1),de=re("tag value"),$e=le(['"'],!0,!1),et=re("move number"),Te=le([["0","9"]],!1,!1),wt=Y(".",!1),se=le(["."],!1,!1),Et=re("standard algebraic notation"),At=Y("O-O-O",!1),kt=Y("O-O",!1),St=Y("0-0-0",!1),Ct=Y("0-0",!1),pe=le([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),xt=le(["+","#"],!1,!1),We=re("suffix annotation"),tt=le(["!","?"],!1,!1),It=re("NAG"),nn=Y("$",!1),$t=re("brace comment"),rn=Y("{",!1),ge=le(["}"],!0,!1),Me=Y("}",!1),ye=re("rest of line comment"),Tt=Y(";",!1),he=le(["\r",`
`],!0,!1),Mt=re("variation"),sn=Y("(",!1),Ot=Y(")",!1),He=re("game termination marker"),Ye=Y("1-0",!1),Pt=Y("0-1",!1),k=Y("1/2-1/2",!1),nt=Y("*",!1),on=re("whitespace"),rt=le([" ","	","\r",`
`],!1,!1),Dt=function(h,g){return Kn(h,g)},Nt=function(h){return Object.fromEntries(h)},Rt=function(h,g){return[h,g]},Lt=function(h,g){return{root:h,marker:g}},Ft=function(h,g){return Bn(Fn(h),...g.flat())},oe=function(h,g,m,x,$){return qn(h,g,m,x,$)},it=function(h){return h},st=function(h){return h.replace(/[\r\n]+/g," ")},an=function(h){return h.trim()},ot=function(h){return h},qt=function(h,g){return{result:h,comment:g}},p=n.peg$currPos|0,Ae=[{line:1,column:1}],ae=p,Qe=n.peg$maxFailExpected||[],A=n.peg$silentFails|0,Oe;if(n.startRule){if(!(n.startRule in l))throw new Error(`Can't start parsing from rule "`+n.startRule+'".');c=l[n.startRule]}function Y(h,g){return{type:"literal",text:h,ignoreCase:g}}function le(h,g,m){return{type:"class",parts:h,inverted:g,ignoreCase:m}}function Bt(){return{type:"end"}}function re(h){return{type:"other",description:h}}function at(h){var g=Ae[h],m;if(g)return g;if(h>=Ae.length)m=Ae.length-1;else for(m=h;!Ae[--m];);for(g=Ae[m],g={line:g.line,column:g.column};m<h;)a.charCodeAt(m)===10?(g.line++,g.column=1):g.column++,m++;return Ae[h]=g,g}function lt(h,g,m){var x=at(h),$=at(g),L={source:s,start:{offset:h,line:x.line,column:x.column},end:{offset:g,line:$.line,column:$.column}};return L}function C(h){p<ae||(p>ae&&(ae=p,Qe=[]),Qe.push(h))}function Kt(h,g,m){return new Ze(Ze.buildMessage(h,g),h,g,m)}function ut(){var h,g,m;return h=p,g=jt(),m=ft(),h=Dt(g,m),h}function jt(){var h,g,m;for(h=p,g=[],m=ct();m!==t;)g.push(m),m=ct();return m=ee(),h=Nt(g),h}function ct(){var h,g,m,x,$,L,ce;return A++,h=p,ee(),a.charCodeAt(p)===91?(g=d,p++):(g=t,A===0&&C(bt)),g!==t?(ee(),m=ln(),m!==t?(ee(),a.charCodeAt(p)===34?(x=u,p++):(x=t,A===0&&C(je)),x!==t?($=Ge(),a.charCodeAt(p)===34?(L=u,p++):(L=t,A===0&&C(je)),L!==t?(ee(),a.charCodeAt(p)===93?(ce=_,p++):(ce=t,A===0&&C(Ie)),ce!==t?h=Rt(m,$):(p=h,h=t)):(p=h,h=t)):(p=h,h=t)):(p=h,h=t)):(p=h,h=t),A--,h===t&&A===0&&C(j),h}function ln(){var h,g,m;if(A++,h=p,g=[],m=a.charAt(p),me.test(m)?p++:(m=t,A===0&&C(Ue)),m!==t)for(;m!==t;)g.push(m),m=a.charAt(p),me.test(m)?p++:(m=t,A===0&&C(Ue));else g=t;return g!==t?h=a.substring(h,p):h=g,A--,h===t&&(g=t,A===0&&C(tn)),h}function Ge(){var h,g,m;for(A++,h=p,g=[],m=a.charAt(p),we.test(m)?p++:(m=t,A===0&&C($e));m!==t;)g.push(m),m=a.charAt(p),we.test(m)?p++:(m=t,A===0&&C($e));return h=a.substring(h,p),A--,g=t,A===0&&C(de),h}function ft(){var h,g,m;return h=p,g=Pe(),ee(),m=Ht(),m===t&&(m=null),ee(),h=Lt(g,m),h}function Pe(){var h,g,m,x;for(h=p,g=ht(),g===t&&(g=null),m=[],x=De();x!==t;)m.push(x),x=De();return h=Ft(g,m),h}function De(){var h,g,m,x,$,L,ce,Re;if(h=p,ee(),Ve(),ee(),g=un(),g!==t){for(m=cn(),m===t&&(m=null),x=[],$=Ut();$!==t;)x.push($),$=Ut();for($=ee(),L=ht(),L===t&&(L=null),ce=[],Re=Ne();Re!==t;)ce.push(Re),Re=Ne();h=oe(g,m,x,L,ce)}else p=h,h=t;return h}function Ve(){var h,g,m,x,$,L;for(A++,h=p,g=[],m=a.charAt(p),fe.test(m)?p++:(m=t,A===0&&C(Te));m!==t;)g.push(m),m=a.charAt(p),fe.test(m)?p++:(m=t,A===0&&C(Te));if(a.charCodeAt(p)===46?(m=w,p++):(m=t,A===0&&C(wt)),m!==t){for(x=ee(),$=[],L=a.charAt(p),_e.test(L)?p++:(L=t,A===0&&C(se));L!==t;)$.push(L),L=a.charAt(p),_e.test(L)?p++:(L=t,A===0&&C(se));g=[g,m,x,$],h=g}else p=h,h=t;return A--,h===t&&(g=t,A===0&&C(et)),h}function un(){var h,g,m,x,$,L;if(A++,h=p,g=p,a.substr(p,5)===i?(m=i,p+=5):(m=t,A===0&&C(At)),m===t&&(a.substr(p,3)===T?(m=T,p+=3):(m=t,A===0&&C(kt)),m===t&&(a.substr(p,5)===E?(m=E,p+=5):(m=t,A===0&&C(St)),m===t&&(a.substr(p,3)===S?(m=S,p+=3):(m=t,A===0&&C(Ct)),m===t))))if(m=p,x=a.charAt(p),me.test(x)?p++:(x=t,A===0&&C(Ue)),x!==t){if($=[],L=a.charAt(p),Xe.test(L)?p++:(L=t,A===0&&C(pe)),L!==t)for(;L!==t;)$.push(L),L=a.charAt(p),Xe.test(L)?p++:(L=t,A===0&&C(pe));else $=t;$!==t?(x=[x,$],m=x):(p=m,m=t)}else p=m,m=t;return m!==t?(x=a.charAt(p),yt.test(x)?p++:(x=t,A===0&&C(xt)),x===t&&(x=null),m=[m,x],g=m):(p=g,g=t),g!==t?h=a.substring(h,p):h=g,A--,h===t&&(g=t,A===0&&C(Et)),h}function cn(){var h,g,m;for(A++,h=p,g=[],m=a.charAt(p),U.test(m)?p++:(m=t,A===0&&C(tt));m!==t;)g.push(m),g.length>=2?m=t:(m=a.charAt(p),U.test(m)?p++:(m=t,A===0&&C(tt)));return g.length<1?(p=h,h=t):h=g,A--,h===t&&(g=t,A===0&&C(We)),h}function Ut(){var h,g,m,x,$;if(A++,h=p,ee(),a.charCodeAt(p)===36?(g=D,p++):(g=t,A===0&&C(nn)),g!==t){if(m=p,x=[],$=a.charAt(p),fe.test($)?p++:($=t,A===0&&C(Te)),$!==t)for(;$!==t;)x.push($),$=a.charAt(p),fe.test($)?p++:($=t,A===0&&C(Te));else x=t;x!==t?m=a.substring(m,p):m=x,m!==t?h=it(m):(p=h,h=t)}else p=h,h=t;return A--,h===t&&A===0&&C(It),h}function ht(){var h;return h=Wt(),h===t&&(h=be()),h}function Wt(){var h,g,m,x,$;if(A++,h=p,a.charCodeAt(p)===123?(g=R,p++):(g=t,A===0&&C(rn)),g!==t){for(m=p,x=[],$=a.charAt(p),xe.test($)?p++:($=t,A===0&&C(ge));$!==t;)x.push($),$=a.charAt(p),xe.test($)?p++:($=t,A===0&&C(ge));m=a.substring(m,p),a.charCodeAt(p)===125?(x=H,p++):(x=t,A===0&&C(Me)),x!==t?h=st(m):(p=h,h=t)}else p=h,h=t;return A--,h===t&&(g=t,A===0&&C($t)),h}function be(){var h,g,m,x,$;if(A++,h=p,a.charCodeAt(p)===59?(g=W,p++):(g=t,A===0&&C(Tt)),g!==t){for(m=p,x=[],$=a.charAt(p),Ee.test($)?p++:($=t,A===0&&C(he));$!==t;)x.push($),$=a.charAt(p),Ee.test($)?p++:($=t,A===0&&C(he));m=a.substring(m,p),h=an(m)}else p=h,h=t;return A--,h===t&&(g=t,A===0&&C(ye)),h}function Ne(){var h,g,m,x;return A++,h=p,ee(),a.charCodeAt(p)===40?(g=N,p++):(g=t,A===0&&C(sn)),g!==t?(m=Pe(),m!==t?(ee(),a.charCodeAt(p)===41?(x=z,p++):(x=t,A===0&&C(Ot)),x!==t?h=ot(m):(p=h,h=t)):(p=h,h=t)):(p=h,h=t),A--,h===t&&A===0&&C(Mt),h}function Ht(){var h,g,m;return A++,h=p,a.substr(p,3)===X?(g=X,p+=3):(g=t,A===0&&C(Ye)),g===t&&(a.substr(p,3)===M?(g=M,p+=3):(g=t,A===0&&C(Pt)),g===t&&(a.substr(p,7)===J?(g=J,p+=7):(g=t,A===0&&C(k)),g===t&&(a.charCodeAt(p)===42?(g=vt,p++):(g=t,A===0&&C(nt))))),g!==t?(ee(),m=ht(),m===t&&(m=null),h=qt(g,m)):(p=h,h=t),A--,h===t&&(g=t,A===0&&C(He)),h}function ee(){var h,g;for(A++,h=[],g=a.charAt(p),ve.test(g)?p++:(g=t,A===0&&C(rt));g!==t;)h.push(g),g=a.charAt(p),ve.test(g)?p++:(g=t,A===0&&C(rt));return A--,g=t,A===0&&C(on),h}if(Oe=c(),n.peg$library)return{peg$result:Oe,peg$currPos:p,peg$FAILED:t,peg$maxFailExpected:Qe,peg$maxFailPos:ae};if(Oe!==t&&p===a.length)return Oe;throw Oe!==t&&p<a.length&&C(Bt()),Kt(Qe,ae<a.length?a.charAt(ae):null,ae<a.length?lt(ae,ae+1):lt(ae,ae))}const Zt=0xffffffffffffffffn;function pn(a,n){return(a<<n|a>>64n-n)&0xffffffffffffffffn}function Tn(a,n){return a*n&Zt}function Wn(a){return function(){let n=BigInt(a&Zt),t=BigInt(a>>64n&Zt);const s=Tn(pn(Tn(n,5n),7n),9n);return t^=n,n=(pn(n,24n)^t^t<<16n)&Zt,t=pn(t,37n),a=t<<64n|n,s}}const en=Wn(0xa187eb39cdcaed8f31c4b365b102e01en),Hn=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>en()))),Yn=Array.from({length:8},()=>en()),Qn=Array.from({length:16},()=>en()),gn=en(),ie="w",ue="b",V="p",En="n",Xt="b",mt="r",Ce="q",Z="k",mn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class zt{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(n,t){const{color:s,piece:l,from:c,to:d,flags:u,captured:_,promotion:w}=t,i=te(c),T=te(d);this.color=s,this.piece=l,this.from=i,this.to=T,this.san=n._moveToSan(t,n._moves({legal:!0})),this.lan=i+T,this.before=n.fen(),n._makeMove(t),this.after=n.fen(),n._undoMove(),this.flags="";for(const E in P)P[E]&u&&(this.flags+=qe[E]);_&&(this.captured=_),w&&(this.promotion=w,this.lan+=w)}isCapture(){return this.flags.indexOf(qe.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(qe.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(qe.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(qe.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(qe.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(qe.BIG_PAWN)>-1}}const ne=-1,qe={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},P={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},An={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Gn={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Vn={...An,...Gn},O={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},_n={b:[16,32,17,15],w:[-16,-32,-17,-15]},Mn={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},zn=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Jn=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Zn={p:1,n:2,b:4,r:8,q:16,k:32},Xn="pnbrqkPNBRQK",On=[En,Xt,mt,Ce],er=7,tr=6,nr=1,rr=0,Jt={[Z]:P.KSIDE_CASTLE,[Ce]:P.QSIDE_CASTLE},ke={w:[{square:O.a1,flag:P.QSIDE_CASTLE},{square:O.h1,flag:P.KSIDE_CASTLE}],b:[{square:O.a8,flag:P.QSIDE_CASTLE},{square:O.h8,flag:P.KSIDE_CASTLE}]},ir={b:nr,w:tr},vn="--";function Ke(a){return a>>4}function _t(a){return a&15}function Ln(a){return"0123456789".indexOf(a)!==-1}function te(a){const n=_t(a),t=Ke(a);return"abcdefgh".substring(n,n+1)+"87654321".substring(t,t+1)}function gt(a){return a===ie?ue:ie}function sr(a){const n=a.split(/\s+/);if(n.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const t=parseInt(n[5],10);if(isNaN(t)||t<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(n[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(n[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(n[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(n[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const l=n[0].split("/");if(l.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let d=0;d<l.length;d++){let u=0,_=!1;for(let w=0;w<l[d].length;w++)if(Ln(l[d][w])){if(_)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};u+=parseInt(l[d][w],10),_=!0}else{if(!/^[prnbqkPRNBQK]$/.test(l[d][w]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};u+=1,_=!1}if(u!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(n[3][1]=="3"&&n[1]=="w"||n[3][1]=="6"&&n[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const c=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:d,regex:u}of c){if(!u.test(n[0]))return{ok:!1,error:`Invalid FEN: missing ${d} king`};if((n[0].match(u)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${d} kings`}}return Array.from(l[0]+l[7]).some(d=>d.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function or(a,n){const t=a.from,s=a.to,l=a.piece;let c=0,d=0,u=0;for(let _=0,w=n.length;_<w;_++){const i=n[_].from,T=n[_].to,E=n[_].piece;l===E&&t!==i&&s===T&&(c++,Ke(t)===Ke(i)&&d++,_t(t)===_t(i)&&u++)}return c>0?d>0&&u>0?te(t):u>0?te(t).charAt(1):te(t).charAt(0):""}function Se(a,n,t,s,l,c=void 0,d=P.NORMAL){const u=Ke(s);if(l===V&&(u===er||u===rr))for(let _=0;_<On.length;_++){const w=On[_];a.push({color:n,from:t,to:s,piece:l,captured:c,promotion:w,flags:d|P.PROMOTION})}else a.push({color:n,from:t,to:s,piece:l,captured:c,flags:d})}function Pn(a){let n=a.charAt(0);return n>="a"&&n<="h"?a.match(/[a-h]\d.*[a-h]\d/)?void 0:V:(n=n.toLowerCase(),n==="o"?Z:n)}function yn(a){return a.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class ar{_board=new Array(128);_turn=ie;_header={};_kings={w:ne,b:ne};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(n=mn,{skipValidation:t=!1}={}){this.load(n,{skipValidation:t})}clear({preserveHeaders:n=!1}={}){this._board=new Array(128),this._kings={w:ne,b:ne},this._turn=ie,this._castling={w:0,b:0},this._epSquare=ne,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=n?this._header:{...Vn},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(n,{skipValidation:t=!1,preserveHeaders:s=!1}={}){let l=n.split(/\s+/);if(l.length>=2&&l.length<6){const u=["-","-","0","1"];n=l.concat(u.slice(-(6-l.length))).join(" ")}if(l=n.split(/\s+/),!t){const{ok:u,error:_}=sr(n);if(!u)throw new Error(_)}const c=l[0];let d=0;this.clear({preserveHeaders:s});for(let u=0;u<c.length;u++){const _=c.charAt(u);if(_==="/")d+=8;else if(Ln(_))d+=parseInt(_,10);else{const w=_<"a"?ie:ue;this._put({type:_.toLowerCase(),color:w},te(d)),d++}}this._turn=l[1],l[2].indexOf("K")>-1&&(this._castling.w|=P.KSIDE_CASTLE),l[2].indexOf("Q")>-1&&(this._castling.w|=P.QSIDE_CASTLE),l[2].indexOf("k")>-1&&(this._castling.b|=P.KSIDE_CASTLE),l[2].indexOf("q")>-1&&(this._castling.b|=P.QSIDE_CASTLE),this._epSquare=l[3]==="-"?ne:O[l[3]],this._halfMoves=parseInt(l[4],10),this._moveNumber=parseInt(l[5],10),this._hash=this._computeHash(),this._updateSetup(n),this._incPositionCount()}fen({forceEnpassantSquare:n=!1}={}){let t=0,s="";for(let d=O.a8;d<=O.h1;d++){if(this._board[d]){t>0&&(s+=t,t=0);const{color:u,type:_}=this._board[d];s+=u===ie?_.toUpperCase():_.toLowerCase()}else t++;d+1&136&&(t>0&&(s+=t),d!==O.h1&&(s+="/"),t=0,d+=8)}let l="";this._castling[ie]&P.KSIDE_CASTLE&&(l+="K"),this._castling[ie]&P.QSIDE_CASTLE&&(l+="Q"),this._castling[ue]&P.KSIDE_CASTLE&&(l+="k"),this._castling[ue]&P.QSIDE_CASTLE&&(l+="q"),l=l||"-";let c="-";if(this._epSquare!==ne)if(n)c=te(this._epSquare);else{const d=this._epSquare+(this._turn===ie?16:-16),u=[d+1,d-1];for(const _ of u){if(_&136)continue;const w=this._turn;if(this._board[_]?.color===w&&this._board[_]?.type===V){this._makeMove({color:w,from:_,to:this._epSquare,piece:V,captured:V,flags:P.EP_CAPTURE});const i=!this._isKingAttacked(w);if(this._undoMove(),i){c=te(this._epSquare);break}}}}return[s,this._turn,l,c,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(n){if(!this._board[n])return 0n;const{color:t,type:s}=this._board[n],l={w:0,b:1}[t],c={p:0,n:1,b:2,r:3,q:4,k:5}[s];return Hn[l][c][n]}_epKey(){return this._epSquare===ne?0n:Yn[this._epSquare&7]}_castlingKey(){const n=this._castling.w>>5|this._castling.b>>3;return Qn[n]}_computeHash(){let n=0n;for(let t=O.a8;t<=O.h1;t++){if(t&136){t+=7;continue}this._board[t]&&(n^=this._pieceKey(t))}return n^=this._epKey(),n^=this._castlingKey(),this._turn==="b"&&(n^=gn),n}_updateSetup(n){this._history.length>0||(n!==mn?(this._header.SetUp="1",this._header.FEN=n):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(mn)}get(n){return this._board[O[n]]}findPiece(n){const t=[];for(let s=O.a8;s<=O.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==n.color||this._board[s].color===n.color&&this._board[s].type===n.type&&t.push(te(s))}return t}put({type:n,color:t},s){return this._put({type:n,color:t},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(n,t){this._hash^=this._pieceKey(n),this._board[n]=t,this._hash^=this._pieceKey(n)}_put({type:n,color:t},s){if(Xn.indexOf(n.toLowerCase())===-1||!(s in O))return!1;const l=O[s];if(n==Z&&!(this._kings[t]==ne||this._kings[t]==l))return!1;const c=this._board[l];return c&&c.type===Z&&(this._kings[c.color]=ne),this._set(l,{type:n,color:t}),n===Z&&(this._kings[t]=l),!0}_clear(n){this._hash^=this._pieceKey(n),delete this._board[n]}remove(n){const t=this.get(n);return this._clear(O[n]),t&&t.type===Z&&(this._kings[t.color]=ne),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),t}_updateCastlingRights(){this._hash^=this._castlingKey();const n=this._board[O.e1]?.type===Z&&this._board[O.e1]?.color===ie,t=this._board[O.e8]?.type===Z&&this._board[O.e8]?.color===ue;(!n||this._board[O.a1]?.type!==mt||this._board[O.a1]?.color!==ie)&&(this._castling.w&=-65),(!n||this._board[O.h1]?.type!==mt||this._board[O.h1]?.color!==ie)&&(this._castling.w&=-33),(!t||this._board[O.a8]?.type!==mt||this._board[O.a8]?.color!==ue)&&(this._castling.b&=-65),(!t||this._board[O.h8]?.type!==mt||this._board[O.h8]?.color!==ue)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===ne)return;const n=this._epSquare+(this._turn===ie?-16:16),t=this._epSquare+(this._turn===ie?16:-16),s=[t+1,t-1];if(this._board[n]!==null||this._board[this._epSquare]!==null||this._board[t]?.color!==gt(this._turn)||this._board[t]?.type!==V){this._hash^=this._epKey(),this._epSquare=ne;return}const l=c=>!(c&136)&&this._board[c]?.color===this._turn&&this._board[c]?.type===V;s.some(l)||(this._hash^=this._epKey(),this._epSquare=ne)}_attacked(n,t,s){const l=[];for(let c=O.a8;c<=O.h1;c++){if(c&136){c+=7;continue}if(this._board[c]===void 0||this._board[c].color!==n)continue;const d=this._board[c],u=c-t;if(u===0)continue;const _=u+119;if(zn[_]&Zn[d.type]){if(d.type===V){if(u>0&&d.color===ie||u<=0&&d.color===ue)if(s)l.push(te(c));else return!0;continue}if(d.type==="n"||d.type==="k")if(s){l.push(te(c));continue}else return!0;const w=Jn[_];let i=c+w,T=!1;for(;i!==t;){if(this._board[i]!=null){T=!0;break}i+=w}if(!T)if(s){l.push(te(c));continue}else return!0}}return s?l:!1}attackers(n,t){return t?this._attacked(t,O[n],!0):this._attacked(this._turn,O[n],!0)}_isKingAttacked(n){const t=this._kings[n];return t===-1?!1:this._attacked(gt(n),t)}hash(){return this._hash.toString(16)}isAttacked(n,t){return this._attacked(t,O[n])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const n={b:0,n:0,r:0,q:0,k:0,p:0},t=[];let s=0,l=0;for(let c=O.a8;c<=O.h1;c++){if(l=(l+1)%2,c&136){c+=7;continue}const d=this._board[c];d&&(n[d.type]=d.type in n?n[d.type]+1:1,d.type===Xt&&t.push(l),s++)}if(s===2)return!0;if(s===3&&(n[Xt]===1||n[En]===1))return!0;if(s===n[Xt]+2){let c=0;const d=t.length;for(let u=0;u<d;u++)c+=t[u];if(c===0||c===d)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:n=!1,square:t=void 0,piece:s=void 0}={}){const l=this._moves({square:t,piece:s});return n?l.map(c=>new zt(this,c)):l.map(c=>this._moveToSan(c,l))}_moves({legal:n=!0,piece:t=void 0,square:s=void 0}={}){const l=s?s.toLowerCase():void 0,c=t?.toLowerCase(),d=[],u=this._turn,_=gt(u);let w=O.a8,i=O.h1,T=!1;if(l)if(l in O)w=i=O[l],T=!0;else return[];for(let S=w;S<=i;S++){if(S&136){S+=7;continue}if(!this._board[S]||this._board[S].color===_)continue;const{type:D}=this._board[S];let R;if(D===V){if(c&&c!==D)continue;R=S+_n[u][0],this._board[R]||(Se(d,u,S,R,V),R=S+_n[u][1],ir[u]===Ke(S)&&!this._board[R]&&Se(d,u,S,R,V,void 0,P.BIG_PAWN));for(let H=2;H<4;H++)R=S+_n[u][H],!(R&136)&&(this._board[R]?.color===_?Se(d,u,S,R,V,this._board[R].type,P.CAPTURE):R===this._epSquare&&Se(d,u,S,R,V,V,P.EP_CAPTURE))}else{if(c&&c!==D)continue;for(let H=0,W=Mn[D].length;H<W;H++){const N=Mn[D][H];for(R=S;R+=N,!(R&136);){if(!this._board[R])Se(d,u,S,R,D);else{if(this._board[R].color===u)break;Se(d,u,S,R,D,this._board[R].type,P.CAPTURE);break}if(D===En||D===Z)break}}}}if((c===void 0||c===Z)&&(!T||i===this._kings[u])){if(this._castling[u]&P.KSIDE_CASTLE){const S=this._kings[u],D=S+2;!this._board[S+1]&&!this._board[D]&&!this._attacked(_,this._kings[u])&&!this._attacked(_,S+1)&&!this._attacked(_,D)&&Se(d,u,this._kings[u],D,Z,void 0,P.KSIDE_CASTLE)}if(this._castling[u]&P.QSIDE_CASTLE){const S=this._kings[u],D=S-2;!this._board[S-1]&&!this._board[S-2]&&!this._board[S-3]&&!this._attacked(_,this._kings[u])&&!this._attacked(_,S-1)&&!this._attacked(_,D)&&Se(d,u,this._kings[u],D,Z,void 0,P.QSIDE_CASTLE)}}if(!n||this._kings[u]===-1)return d;const E=[];for(let S=0,D=d.length;S<D;S++)this._makeMove(d[S]),this._isKingAttacked(u)||E.push(d[S]),this._undoMove();return E}move(n,{strict:t=!1}={}){let s=null;if(typeof n=="string")s=this._moveFromSan(n,t);else if(n===null)s=this._moveFromSan(vn,t);else if(typeof n=="object"){const c=this._moves();for(let d=0,u=c.length;d<u;d++)if(n.from===te(c[d].from)&&n.to===te(c[d].to)&&(!("promotion"in c[d])||n.promotion===c[d].promotion)){s=c[d];break}}if(!s)throw typeof n=="string"?new Error(`Invalid move: ${n}`):new Error(`Invalid move: ${JSON.stringify(n)}`);if(this.isCheck()&&s.flags&P.NULL_MOVE)throw new Error("Null move not allowed when in check");const l=new zt(this,s);return this._makeMove(s),this._incPositionCount(),l}_push(n){this._history.push({move:n,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(n,t){this._hash^=this._pieceKey(n),this._board[t]=this._board[n],delete this._board[n],this._hash^=this._pieceKey(t)}_makeMove(n){const t=this._turn,s=gt(t);if(this._push(n),n.flags&P.NULL_MOVE){t===ue&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=ne;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),n.captured&&(this._hash^=this._pieceKey(n.to)),this._movePiece(n.from,n.to),n.flags&P.EP_CAPTURE&&(this._turn===ue?this._clear(n.to-16):this._clear(n.to+16)),n.promotion&&(this._clear(n.to),this._set(n.to,{type:n.promotion,color:t})),this._board[n.to].type===Z){if(this._kings[t]=n.to,n.flags&P.KSIDE_CASTLE){const l=n.to-1,c=n.to+1;this._movePiece(c,l)}else if(n.flags&P.QSIDE_CASTLE){const l=n.to+1,c=n.to-2;this._movePiece(c,l)}this._castling[t]=0}if(this._castling[t]){for(let l=0,c=ke[t].length;l<c;l++)if(n.from===ke[t][l].square&&this._castling[t]&ke[t][l].flag){this._castling[t]^=ke[t][l].flag;break}}if(this._castling[s]){for(let l=0,c=ke[s].length;l<c;l++)if(n.to===ke[s][l].square&&this._castling[s]&ke[s][l].flag){this._castling[s]^=ke[s][l].flag;break}}if(this._hash^=this._castlingKey(),n.flags&P.BIG_PAWN){let l;t===ue?l=n.to-16:l=n.to+16,!(n.to-1&136)&&this._board[n.to-1]?.type===V&&this._board[n.to-1]?.color===s||!(n.to+1&136)&&this._board[n.to+1]?.type===V&&this._board[n.to+1]?.color===s?(this._epSquare=l,this._hash^=this._epKey()):this._epSquare=ne}else this._epSquare=ne;n.piece===V?this._halfMoves=0:n.flags&(P.CAPTURE|P.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,t===ue&&this._moveNumber++,this._turn=s,this._hash^=gn}undo(){const n=this._hash,t=this._undoMove();if(t){const s=new zt(this,t);return this._decPositionCount(n),s}return null}_undoMove(){const n=this._history.pop();if(n===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const t=n.move;this._kings=n.kings,this._turn=n.turn,this._castling=n.castling,this._epSquare=n.epSquare,this._halfMoves=n.halfMoves,this._moveNumber=n.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=gn;const s=this._turn,l=gt(s);if(t.flags&P.NULL_MOVE)return t;if(this._movePiece(t.to,t.from),t.piece&&(this._clear(t.from),this._set(t.from,{type:t.piece,color:s})),t.captured)if(t.flags&P.EP_CAPTURE){let c;s===ue?c=t.to-16:c=t.to+16,this._set(c,{type:V,color:l})}else this._set(t.to,{type:t.captured,color:l});if(t.flags&(P.KSIDE_CASTLE|P.QSIDE_CASTLE)){let c,d;t.flags&P.KSIDE_CASTLE?(c=t.to+1,d=t.to-1):(c=t.to-2,d=t.to+1),this._movePiece(d,c)}return t}pgn({newline:n=`
`,maxWidth:t=0}={}){const s=[];let l=!1;for(const E in this._header)this._header[E]&&s.push(`[${E} "${this._header[E]}"]`+n),l=!0;l&&this._history.length&&s.push(n);const c=E=>{const S=this._comments[this.fen()];if(typeof S<"u"){const D=E.length>0?" ":"";E=`${E}${D}{${S}}`}return E},d=[];for(;this._history.length>0;)d.push(this._undoMove());const u=[];let _="";for(d.length===0&&u.push(c(""));d.length>0;){_=c(_);const E=d.pop();if(!E)break;if(!this._history.length&&E.color==="b"){const S=`${this._moveNumber}. ...`;_=_?`${_} ${S}`:S}else E.color==="w"&&(_.length&&u.push(_),_=this._moveNumber+".");_=_+" "+this._moveToSan(E,this._moves({legal:!0})),this._makeMove(E)}if(_.length&&u.push(c(_)),u.push(this._header.Result||"*"),t===0)return s.join("")+u.join(" ");const w=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},i=function(E,S){for(const D of S.split(" "))if(D){if(E+D.length>t){for(;w();)E--;s.push(n),E=0}s.push(D),E+=D.length,s.push(" "),E++}return w()&&E--,E};let T=0;for(let E=0;E<u.length;E++){if(T+u[E].length>t&&u[E].includes("{")){T=i(T,u[E]);continue}T+u[E].length>t&&E!==0?(s[s.length-1]===" "&&s.pop(),s.push(n),T=0):E!==0&&(s.push(" "),T++),s.push(u[E]),T+=u[E].length}return s.join("")}header(...n){for(let t=0;t<n.length;t+=2)typeof n[t]=="string"&&typeof n[t+1]=="string"&&(this._header[n[t]]=n[t+1]);return this._header}setHeader(n,t){return this._header[n]=t??An[n]??null,this.getHeaders()}removeHeader(n){return n in this._header?(this._header[n]=An[n]||null,!0):!1}getHeaders(){const n={};for(const[t,s]of Object.entries(this._header))s!==null&&(n[t]=s);return n}loadPgn(n,{strict:t=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(n=n.replace(new RegExp(s,"g"),`
`));const l=Un(n);this.reset();const c=l.headers;let d="";for(const w in c)w.toLowerCase()==="fen"&&(d=c[w]),this.header(w,c[w]);if(!t)d&&this.load(d,{preserveHeaders:!0});else if(c.SetUp==="1"){if(!("FEN"in c))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(c.FEN,{preserveHeaders:!0})}let u=l.root;for(;u;){if(u.move){const w=this._moveFromSan(u.move,t);if(w==null)throw new Error(`Invalid move in PGN: ${u.move}`);this._makeMove(w),this._incPositionCount()}u.comment!==void 0&&(this._comments[this.fen()]=u.comment),u=u.variations[0]}const _=l.result;_&&Object.keys(this._header).length&&this._header.Result!==_&&this.setHeader("Result",_)}_moveToSan(n,t){let s="";if(n.flags&P.KSIDE_CASTLE)s="O-O";else if(n.flags&P.QSIDE_CASTLE)s="O-O-O";else{if(n.flags&P.NULL_MOVE)return vn;if(n.piece!==V){const l=or(n,t);s+=n.piece.toUpperCase()+l}n.flags&(P.CAPTURE|P.EP_CAPTURE)&&(n.piece===V&&(s+=te(n.from)[0]),s+="x"),s+=te(n.to),n.promotion&&(s+="="+n.promotion.toUpperCase())}return this._makeMove(n),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(n,t=!1){let s=yn(n);if(t||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==vn)return{color:this._turn,from:0,to:0,piece:"k",flags:P.NULL_MOVE};let l=Pn(s),c=this._moves({legal:!0,piece:l});for(let E=0,S=c.length;E<S;E++)if(s===yn(this._moveToSan(c[E],c)))return c[E];if(t)return null;let d,u,_,w,i,T=!1;if(u=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),u?(d=u[1],_=u[2],w=u[3],i=u[4],_.length==1&&(T=!0)):(u=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),u&&(d=u[1],_=u[2],w=u[3],i=u[4],_.length==1&&(T=!0))),l=Pn(s),c=this._moves({legal:!0,piece:d||l}),!w)return null;for(let E=0,S=c.length;E<S;E++)if(_){if((!d||d.toLowerCase()==c[E].piece)&&O[_]==c[E].from&&O[w]==c[E].to&&(!i||i.toLowerCase()==c[E].promotion))return c[E];if(T){const D=te(c[E].from);if((!d||d.toLowerCase()==c[E].piece)&&O[w]==c[E].to&&(_==D[0]||_==D[1])&&(!i||i.toLowerCase()==c[E].promotion))return c[E]}}else if(s===yn(this._moveToSan(c[E],c)).replace("x",""))return c[E];return null}ascii(){let n=`   +------------------------+
`;for(let t=O.a8;t<=O.h1;t++){if(_t(t)===0&&(n+=" "+"87654321"[Ke(t)]+" |"),this._board[t]){const s=this._board[t].type,c=this._board[t].color===ie?s.toUpperCase():s.toLowerCase();n+=" "+c+" "}else n+=" . ";t+1&136&&(n+=`|
`,t+=8)}return n+=`   +------------------------+
`,n+="     a  b  c  d  e  f  g  h",n}perft(n){const t=this._moves({legal:!1});let s=0;const l=this._turn;for(let c=0,d=t.length;c<d;c++)this._makeMove(t[c]),this._isKingAttacked(l)||(n-1>0?s+=this.perft(n-1):s++),this._undoMove();return s}setTurn(n){return this._turn==n?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const n=[];let t=[];for(let s=O.a8;s<=O.h1;s++)this._board[s]==null?t.push(null):t.push({square:te(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(n.push(t),t=[],s+=8);return n}squareColor(n){if(n in O){const t=O[n];return(Ke(t)+_t(t))%2===0?"light":"dark"}return null}history({verbose:n=!1}={}){const t=[],s=[];for(;this._history.length>0;)t.push(this._undoMove());for(;;){const l=t.pop();if(!l)break;n?s.push(new zt(this,l)):s.push(this._moveToSan(l,this._moves())),this._makeMove(l)}return s}_getPositionCount(n){return this._positionCount.get(n)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(n){const t=this._positionCount.get(n)??0;t===1?this._positionCount.delete(n):this._positionCount.set(n,t-1)}_pruneComments(){const n=[],t={},s=l=>{l in this._comments&&(t[l]=this._comments[l])};for(;this._history.length>0;)n.push(this._undoMove());for(s(this.fen());;){const l=n.pop();if(!l)break;this._makeMove(l),s(this.fen())}this._comments=t}getComment(){return this._comments[this.fen()]}setComment(n){this._comments[this.fen()]=n.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const n=this._comments[this.fen()];return delete this._comments[this.fen()],n}getComments(){return this._pruneComments(),Object.keys(this._comments).map(n=>({fen:n,comment:this._comments[n]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(n=>{const t=this._comments[n];return delete this._comments[n],{fen:n,comment:t}})}setCastlingRights(n,t){for(const l of[Z,Ce])t[l]!==void 0&&(t[l]?this._castling[n]|=Jt[l]:this._castling[n]&=~Jt[l]);this._updateCastlingRights();const s=this.getCastlingRights(n);return(t[Z]===void 0||t[Z]===s[Z])&&(t[Ce]===void 0||t[Ce]===s[Ce])}getCastlingRights(n){return{[Z]:(this._castling[n]&Jt[Z])!==0,[Ce]:(this._castling[n]&Jt[Ce])!==0}}moveNumber(){return this._moveNumber}}var Dn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function lr(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}function ur(a){if(Object.prototype.hasOwnProperty.call(a,"__esModule"))return a;var n=a.default;if(typeof n=="function"){var t=function s(){var l=!1;try{l=this instanceof s}catch{}return l?Reflect.construct(n,arguments,this.constructor):n.apply(this,arguments)};t.prototype=n.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(a).forEach(function(s){var l=Object.getOwnPropertyDescriptor(a,s);Object.defineProperty(t,s,l.get?l:{enumerable:!0,get:function(){return a[s]}})}),t}var bn={exports:{}};const cr={},fr=Object.freeze(Object.defineProperty({__proto__:null,default:cr},Symbol.toStringTag,{value:"Module"})),Be=ur(fr);var Nn;function hr(){return Nn||(Nn=1,(function(a,n){var t=(function(){var s=typeof document<"u"&&document.currentScript?document.currentScript.src:void 0;return typeof __filename<"u"&&(s=s||__filename),(function(l){l=l||{};function c(){return j.buffer!=se&&pe(j.buffer),Et}function d(){return j.buffer!=se&&pe(j.buffer),At}function u(){return j.buffer!=se&&pe(j.buffer),kt}function _(){return j.buffer!=se&&pe(j.buffer),St}function w(){return j.buffer!=se&&pe(j.buffer),Ct}var i;i||(i=typeof l<"u"?l:{});var T,E;i.ready=new Promise(function(e,r){T=e,E=r}),(function(){function e(){var y=f.shift();if(!r&&y!==void 0){if(y==="quit")return i.terminate();var I=i.ccall("uci_command","number",["string"],[y]);I&&f.unshift(y),b=I?2*b:1,setTimeout(e,b)}}var r=!1,o=[];i.print=function(y){o.length===0?console.log(y):setTimeout(function(){for(var I=0;I<o.length;I++)o[I](y)})},i.addMessageListener=function(y){o.push(y)},i.removeMessageListener=function(y){y=o.indexOf(y),0<=y&&o.splice(y,1)},i.terminate=function(){r=!0,k.Ea()};var f=[],b=1;i.postMessage=function(y){f.push(y)},i.postRun=function(){i.postMessage=function(y){f.push(y),f.length===1&&e()},e()}})();var S={},D;for(D in i)i.hasOwnProperty(D)&&(S[D]=i[D]);var R=[],H="./this.program";function W(e,r){throw r}var N=!1,z=!1,X=!1;N=typeof window=="object",z=typeof importScripts=="function",X=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string";var M=i.ENVIRONMENT_IS_PTHREAD||!1;M&&(se=i.buffer);var J="";function vt(e){return i.locateFile?i.locateFile(e,J):J+e}var me,we,fe,_e;if(X){J=z?Be.dirname(J)+"/":__dirname+"/",me=function(e,r){return fe||(fe=Be),_e||(_e=Be),e=_e.normalize(e),fe.readFileSync(e,r?null:"utf8")},we=function(e){return e=me(e,!0),e.buffer||(e=new Uint8Array(e)),Ie(e.buffer),e},1<process.argv.length&&(H=process.argv[1].replace(/\\/g,"/")),R=process.argv.slice(2),process.on("uncaughtException",function(e){if(!(e instanceof Je))throw e}),process.on("unhandledRejection",ye),W=function(e){process.exit(e)},i.inspect=function(){return"[Emscripten Module object]"};var Xe;try{Xe=Be}catch(e){throw console.error('The "worker_threads" module is not supported in this node.js build - perhaps a newer version is needed?'),e}Dn.Worker=Xe.Worker}else(N||z)&&(z?J=self.location.href:typeof document<"u"&&document.currentScript&&(J=document.currentScript.src),s&&(J=s),J.indexOf("blob:")!==0?J=J.substr(0,J.lastIndexOf("/")+1):J="",X?(me=function(e,r){return fe||(fe=Be),_e||(_e=Be),e=_e.normalize(e),fe.readFileSync(e,r?null:"utf8")},we=function(e){return e=me(e,!0),e.buffer||(e=new Uint8Array(e)),Ie(e.buffer),e}):(me=function(e){var r=new XMLHttpRequest;return r.open("GET",e,!1),r.send(null),r.responseText},z&&(we=function(e){var r=new XMLHttpRequest;return r.open("GET",e,!1),r.responseType="arraybuffer",r.send(null),new Uint8Array(r.response)})));X&&typeof performance>"u"&&(Dn.performance=Be.performance);var yt=i.print||console.log.bind(console),U=i.printErr||console.warn.bind(console);for(D in S)S.hasOwnProperty(D)&&(i[D]=S[D]);S=null,i.arguments&&(R=i.arguments),i.thisProgram&&(H=i.thisProgram),i.quit&&(W=i.quit);var xe,Ee;i.wasmBinary&&(Ee=i.wasmBinary);var ve;i.noExitRuntime&&(ve=i.noExitRuntime),typeof WebAssembly!="object"&&ye("no native wasm support detected");var j,bt,je=!1;function Ie(e,r){e||ye("Assertion failed: "+r)}function tn(e){var r=i["_"+e];return Ie(r,"Cannot call unknown function "+e+", make sure it is exported"),r}function Ue(e,r,o){o=r+o;for(var f="";!(r>=o);){var b=e[r++];if(!b)break;if(b&128){var y=e[r++]&63;if((b&224)==192)f+=String.fromCharCode((b&31)<<6|y);else{var I=e[r++]&63;b=(b&240)==224?(b&15)<<12|y<<6|I:(b&7)<<18|y<<12|I<<6|e[r++]&63,65536>b?f+=String.fromCharCode(b):(b-=65536,f+=String.fromCharCode(55296|b>>10,56320|b&1023))}}else f+=String.fromCharCode(b)}return f}function de(e){return e?Ue(d(),e,void 0):""}function $e(e,r,o,f){if(0<f){f=o+f-1;for(var b=0;b<e.length;++b){var y=e.charCodeAt(b);if(55296<=y&&57343>=y){var I=e.charCodeAt(++b);y=65536+((y&1023)<<10)|I&1023}if(127>=y){if(o>=f)break;r[o++]=y}else{if(2047>=y){if(o+1>=f)break;r[o++]=192|y>>6}else{if(65535>=y){if(o+2>=f)break;r[o++]=224|y>>12}else{if(o+3>=f)break;r[o++]=240|y>>18,r[o++]=128|y>>12&63}r[o++]=128|y>>6&63}r[o++]=128|y&63}}r[o]=0}}function et(e){for(var r=0,o=0;o<e.length;++o){var f=e.charCodeAt(o);55296<=f&&57343>=f&&(f=65536+((f&1023)<<10)|e.charCodeAt(++o)&1023),127>=f?++r:r=2047>=f?r+2:65535>=f?r+3:r+4}return r}function Te(e){var r=et(e)+1,o=Le(r);return $e(e,c(),o,r),o}function wt(e,r){c().set(e,r)}var se,Et,At,kt,St,Ct;function pe(e){se=e,i.HEAP8=Et=new Int8Array(e),i.HEAP16=new Int16Array(e),i.HEAP32=kt=new Int32Array(e),i.HEAPU8=At=new Uint8Array(e),i.HEAPU16=new Uint16Array(e),i.HEAPU32=St=new Uint32Array(e),i.HEAPF32=new Float32Array(e),i.HEAPF64=Ct=new Float64Array(e)}var xt=i.INITIAL_MEMORY||67108864;if(M)j=i.wasmMemory,se=i.buffer;else if(i.wasmMemory)j=i.wasmMemory;else if(j=new WebAssembly.Memory({initial:xt/65536,maximum:32768,shared:!0}),!(j.buffer instanceof SharedArrayBuffer))throw U("requested a shared WebAssembly.Memory but the returned buffer is not a SharedArrayBuffer, indicating that while the browser has SharedArrayBuffer it does not have WebAssembly threads support - you may need to set a flag"),X&&console.log("(on node you may need: --experimental-wasm-threads --experimental-wasm-bulk-memory and also use a recent version)"),Error("bad memory");j&&(se=j.buffer),xt=se.byteLength,pe(se);var We,tt=[],It=[],nn=[],$t=[];M||It.push({Ia:function(){Wt()}});function rn(){var e=i.preRun.shift();tt.unshift(e)}var ge=0,Me=null;i.preloadedImages={},i.preloadedAudios={};function ye(e){throw i.onAbort&&i.onAbort(e),M&&console.error("Pthread aborting at "+Error().stack),U(e),je=!0,e=new WebAssembly.RuntimeError("abort("+e+"). Build with -s ASSERTIONS=1 for more info."),E(e),e}function Tt(){var e=he;return String.prototype.startsWith?e.startsWith("data:application/octet-stream;base64,"):e.indexOf("data:application/octet-stream;base64,")===0}var he="stockfish.wasm";Tt()||(he=vt(he));function Mt(){var e=he;try{if(e==he&&Ee)return new Uint8Array(Ee);if(we)return we(e);throw"both async and sync fetching of the wasm failed"}catch(r){ye(r)}}function sn(){return Ee||!N&&!z||typeof fetch!="function"?Promise.resolve().then(function(){return Mt()}):fetch(he,{credentials:"same-origin"}).then(function(e){if(!e.ok)throw"failed to load wasm binary file at '"+he+"'";return e.arrayBuffer()}).catch(function(){return Mt()})}var Ot={11752:function(){throw"Canceled!"},12164:function(e,r){setTimeout(function(){$(e,r)},0)}};function He(e){for(;0<e.length;){var r=e.shift();if(typeof r=="function")r(i);else{var o=r.Ia;typeof o=="number"?r.ma===void 0?We.get(o)():We.get(o)(r.ma):o(r.ma===void 0?null:r.ma)}}}function Ye(e,r){if(0>=e||e>c().length||e&1||0>r)return-28;if(r==0)return 0;2147483647<=r&&(r=1/0);var o=Atomics.load(u(),ze>>2),f=0;if(o==e&&Atomics.compareExchange(u(),ze>>2,o,0)==o&&(--r,f=1,0>=r))return 1;if(e=Atomics.notify(u(),e>>2,r),0<=e)return e+f;throw"Atomics.notify returned an unexpected value "+e}i._emscripten_futex_wake=Ye;function Pt(e){if(M)throw"Internal Error! cleanupThread() can only ever be called from main application thread!";if(!e)throw"Internal Error! Null pthread_ptr in cleanupThread!";u()[e+12>>2]=0,(e=k.ga[e])&&k.ta(e.worker)}var k={fa:[],ia:[],La:function(){for(var e=0;1>e;++e)k.za()},Ma:function(){for(var e=be(228),r=0;57>r;++r)_()[e/4+r]=0;u()[e+12>>2]=e,r=e+152,u()[r>>2]=r;var o=be(512);for(r=0;128>r;++r)_()[o/4+r]=0;Atomics.store(_(),e+100>>2,o),Atomics.store(_(),e+40>>2,e),Yt(e,!z,1),m(e)},Na:function(){k.receiveObjectTransfer=k.Pa,k.setThreadStatus=k.Ra,k.threadCancel=k.Ta,k.threadExit=k.Ua},ga:{},Fa:[],Ra:function(){},Da:function(){for(;0<k.Fa.length;)k.Fa.pop()();M&&h()&&g()},Ua:function(e){var r=h();r&&(Atomics.store(_(),r+4>>2,e),Atomics.store(_(),r+0>>2,1),Atomics.store(_(),r+56>>2,1),Atomics.store(_(),r+60>>2,0),k.Da(),Ye(r+0,2147483647),Yt(0,0,0),M&&postMessage({cmd:"exit"}))},Ta:function(){k.Da();var e=h();Atomics.store(_(),e+4>>2,-1),Atomics.store(_(),e+0>>2,1),Ye(e+0,2147483647),Yt(0,0,0),postMessage({cmd:"cancelDone"})},Ea:function(){for(var e in k.ga){var r=k.ga[e];r&&r.worker&&k.ta(r.worker)}for(k.ga={},e=0;e<k.fa.length;++e){var o=k.fa[e];o.terminate()}for(k.fa=[],e=0;e<k.ia.length;++e)o=k.ia[e],r=o.ea,k.ya(r),o.terminate();k.ia=[]},ya:function(e){if(e){if(e.ha){var r=u()[e.ha+100>>2];u()[e.ha+100>>2]=0,Ne(r),Ne(e.ha)}e.ha=0,e.xa&&e.ja&&Ne(e.ja),e.ja=0,e.worker&&(e.worker.ea=null)}},ta:function(e){k.Qa(function(){delete k.ga[e.ea.ha],k.fa.push(e),k.ia.splice(k.ia.indexOf(e),1),k.ya(e.ea),e.ea=void 0})},Qa:function(e){u()[xn>>2]=0;try{e()}finally{u()[xn>>2]=1}},Pa:function(){},Ba:function(e,r){e.onmessage=function(o){var f=o.data,b=f.cmd;if(e.ea&&(k.Ga=e.ea.ha),f.targetThread&&f.targetThread!=h()){var y=k.ga[f.lb];y?y.worker.postMessage(o.data,f.transferList):console.error('Internal error! Worker sent a message "'+b+'" to target pthread '+f.targetThread+", but that thread no longer exists!")}else if(b==="processQueuedMainThreadWork")ce();else if(b==="spawnThread")ct(o.data);else if(b==="cleanupThread")Pt(f.thread);else if(b==="killThread"){if(o=f.thread,M)throw"Internal Error! killThread() can only ever be called from main application thread!";if(!o)throw"Internal Error! Null pthread_ptr in killThread!";u()[o+12>>2]=0,o=k.ga[o],o.worker.terminate(),k.ya(o),k.ia.splice(k.ia.indexOf(o.worker),1),o.worker.ea=void 0}else if(b==="cancelThread"){if(o=f.thread,M)throw"Internal Error! cancelThread() can only ever be called from main application thread!";if(!o)throw"Internal Error! Null pthread_ptr in cancelThread!";k.ga[o].worker.postMessage({cmd:"cancel"})}else if(b==="loaded")e.loaded=!0,r&&r(e),e.na&&(e.na(),delete e.na);else if(b==="print")yt("Thread "+f.threadId+": "+f.text);else if(b==="printErr")U("Thread "+f.threadId+": "+f.text);else if(b==="alert")alert("Thread "+f.threadId+": "+f.text);else if(b==="exit")e.ea&&Atomics.load(_(),e.ea.ha+64>>2)&&k.ta(e);else if(b==="exitProcess")try{hn(f.returnCode)}catch(I){if(I instanceof Je)return;throw I}else b==="cancelDone"?k.ta(e):b!=="objectTransfer"&&(o.data.target==="setimmediate"?e.postMessage(o.data):U("worker sent an unknown command "+b));k.Ga=void 0},e.onerror=function(o){U("pthread sent an error! "+o.filename+":"+o.lineno+": "+o.message)},X&&(e.on("message",function(o){e.onmessage({data:o})}),e.on("error",function(o){e.onerror(o)}),e.on("exit",function(){})),e.postMessage({cmd:"load",urlOrBlob:i.mainScriptUrlOrBlob||s,wasmMemory:j,wasmModule:bt})},za:function(){var e=vt("stockfish.worker.js");k.fa.push(new Worker(e))},Ja:function(){return k.fa.length==0&&(k.za(),k.Ba(k.fa[0])),0<k.fa.length?k.fa.pop():null},$a:function(e){for(e=performance.now()+e;performance.now()<e;);}};i.establishStackSpace=function(e,r){Sn(e,r),dt(e)},i.getNoExitRuntime=function(){return ve},i.invokeEntryPoint=function(e,r){return We.get(e)(r)};var nt;nt=X?function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:M?function(){return performance.now()-i.__performance_now_clock_drift}:function(){return performance.now()};var on=[null,[],[]],rt={};function Dt(e,r,o){return M?oe(2,1,e,r,o):0}function Nt(e,r,o){return M?oe(3,1,e,r,o):0}function Rt(e,r,o){if(M)return oe(4,1,e,r,o)}function Lt(){X||z||(xe||(xe={}),xe["Blocking on the main thread is very dangerous, see https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread"]||(xe["Blocking on the main thread is very dangerous, see https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread"]=1,U("Blocking on the main thread is very dangerous, see https://emscripten.org/docs/porting/pthreads.html#blocking-on-the-main-browser-thread")))}function Ft(e,r,o){if(0>=e||e>c().length||e&1)return-28;if(N){if(Atomics.load(u(),e>>2)!=r)return-6;var f=performance.now();for(o=f+o,Atomics.exchange(u(),ze>>2,e);;){if(f=performance.now(),f>o)return Atomics.exchange(u(),ze>>2,0),-73;if(f=Atomics.exchange(u(),ze>>2,0),f==0)break;if(ce(),Atomics.load(u(),e>>2)!=r)return-6;Atomics.exchange(u(),ze>>2,e)}return 0}if(e=Atomics.wait(u(),e>>2,r,o),e==="timed-out")return-73;if(e==="not-equal")return-6;if(e==="ok")return 0;throw"Atomics.wait returned an unexpected value "+e}function oe(e,r){for(var o=arguments.length-2,f=Qt(),b=Le(8*o),y=b>>3,I=0;I<o;I++){var F=arguments[2+I];w()[y+I]=F}return o=Re(e,o,b,r),dt(f),o}var it=[],st=[],an=[0,typeof document<"u"?document:0,typeof window<"u"?window:0];function ot(e){return e=2<e?de(e):e,an[e]||(typeof document<"u"?document.querySelector(e):void 0)}function qt(e,r,o){var f=ot(e);if(!f)return-4;if(f.ra&&(u()[f.ra>>2]=r,u()[f.ra+4>>2]=o),f.Ca||!f.bb)f.Ca&&(f=f.Ca),e=!1,f.qa&&f.qa.pa&&(e=f.qa.pa.getParameter(2978),e=e[0]===0&&e[1]===0&&e[2]===f.width&&e[3]===f.height),f.width=r,f.height=o,e&&f.qa.pa.viewport(0,0,r,o);else{if(f.ra){f=u()[f.ra+8>>2],e=e?de(e):"";var b=Qt(),y=Le(12),I=0;if(e){I=et(e)+1;var F=be(I);$e(e,d(),F,I),I=F}return u()[y>>2]=I,u()[y+4>>2]=r,u()[y+8>>2]=o,kn(0,f,657457152,0,I,y),dt(b),1}return-4}return 0}function p(e,r,o){return M?oe(5,1,e,r,o):qt(e,r,o)}function Ae(e){var r=e.getExtension("ANGLE_instanced_arrays");r&&(e.vertexAttribDivisor=function(o,f){r.vertexAttribDivisorANGLE(o,f)},e.drawArraysInstanced=function(o,f,b,y){r.drawArraysInstancedANGLE(o,f,b,y)},e.drawElementsInstanced=function(o,f,b,y,I){r.drawElementsInstancedANGLE(o,f,b,y,I)})}function ae(e){var r=e.getExtension("OES_vertex_array_object");r&&(e.createVertexArray=function(){return r.createVertexArrayOES()},e.deleteVertexArray=function(o){r.deleteVertexArrayOES(o)},e.bindVertexArray=function(o){r.bindVertexArrayOES(o)},e.isVertexArray=function(o){return r.isVertexArrayOES(o)})}function Qe(e){var r=e.getExtension("WEBGL_draw_buffers");r&&(e.drawBuffers=function(o,f){r.drawBuffersWEBGL(o,f)})}function A(e){if(e||(e=Oe),!e.Ka){e.Ka=!0;var r=e.pa;Ae(r),ae(r),Qe(r),r.cb=r.getExtension("EXT_disjoint_timer_query"),r.ib=r.getExtension("WEBGL_multi_draw"),(r.getSupportedExtensions()||[]).forEach(function(o){0>o.indexOf("lose_context")&&0>o.indexOf("debug")&&r.getExtension(o)})}}var Oe,Y=["default","low-power","high-performance"],le={};function Bt(){if(!re){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:H||"./this.program"},r;for(r in le)e[r]=le[r];var o=[];for(r in e)o.push(r+"="+e[r]);re=o}return re}var re;function at(e,r){if(M)return oe(6,1,e,r);var o=0;return Bt().forEach(function(f,b){var y=r+o;for(b=u()[e+4*b>>2]=y,y=0;y<f.length;++y)c()[b++>>0]=f.charCodeAt(y);c()[b>>0]=0,o+=f.length+1}),0}function lt(e,r){if(M)return oe(7,1,e,r);var o=Bt();u()[e>>2]=o.length;var f=0;return o.forEach(function(b){f+=b.length+1}),u()[r>>2]=f,0}function C(e){return M?oe(8,1,e):0}function Kt(e,r,o,f){return M?oe(9,1,e,r,o,f):(e=rt.fb(e),r=rt.eb(e,r,o),u()[f>>2]=r,0)}function ut(e,r,o,f,b){if(M)return oe(10,1,e,r,o,f,b)}function jt(e,r,o,f){if(M)return oe(11,1,e,r,o,f);for(var b=0,y=0;y<o;y++){for(var I=u()[r+8*y>>2],F=u()[r+(8*y+4)>>2],K=0;K<F;K++){var B=d()[I+K],Q=on[e];B===0||B===10?((e===1?yt:U)(Ue(Q,0)),Q.length=0):Q.push(B)}b+=F}return u()[f>>2]=b,0}function ct(e){if(M)throw"Internal Error! spawnThread() can only ever be called from main application thread!";var r=k.Ja();if(r.ea!==void 0)throw"Internal error!";if(!e.sa)throw"Internal error, no pthread ptr!";k.ia.push(r);for(var o=be(512),f=0;128>f;++f)u()[o+4*f>>2]=0;var b=e.ja+e.ka;f=k.ga[e.sa]={worker:r,ja:e.ja,ka:e.ka,xa:e.xa,ha:e.sa};var y=f.ha>>2;Atomics.store(_(),y+16,e.detached),Atomics.store(_(),y+25,o),Atomics.store(_(),y+10,f.ha),Atomics.store(_(),y+20,e.ka),Atomics.store(_(),y+19,b),Atomics.store(_(),y+26,e.ka),Atomics.store(_(),y+28,b),Atomics.store(_(),y+29,e.detached),o=Ht()+40,Atomics.store(_(),y+43,o),r.ea=f;var I={cmd:"run",start_routine:e.Sa,arg:e.ma,threadInfoStruct:e.sa,stackBase:e.ja,stackSize:e.ka};r.na=function(){I.time=performance.now(),r.postMessage(I,e.Za)},r.loaded&&(r.na(),delete r.na)}function ln(e,r){if(!e)return U("pthread_join attempted on a null thread pointer!"),71;if(M&&h()==e)return U("PThread "+e+" is attempting to join to itself!"),16;if(!M&&x()==e)return U("Main thread "+e+" is attempting to join to itself!"),16;if(u()[e+12>>2]!==e)return U("pthread_join attempted on thread "+e+", which does not point to a valid thread, or does not exist anymore!"),71;if(Atomics.load(_(),e+64>>2))return U("Attempted to join thread "+e+", which was already detached!"),28;for(Lt();;){var o=Atomics.load(_(),e+0>>2);if(o==1)return o=Atomics.load(_(),e+4>>2),r&&(u()[r>>2]=o),Atomics.store(_(),e+64>>2,1),M?postMessage({cmd:"cleanupThread",thread:e}):Pt(e),0;if(M){var f=h();if(f&&!Atomics.load(_(),f+56>>2)&&Atomics.load(_(),f+0>>2)==2)throw"Canceled!"}M||ce(),Ft(e+0,o,M?100:1)}}function Ge(e){return e%4===0&&(e%100!==0||e%400===0)}function ft(e,r){for(var o=0,f=0;f<=r;o+=e[f++]);return o}var Pe=[31,29,31,30,31,30,31,31,30,31,30,31],De=[31,28,31,30,31,30,31,31,30,31,30,31];function Ve(e,r){for(e=new Date(e.getTime());0<r;){var o=e.getMonth(),f=(Ge(e.getFullYear())?Pe:De)[o];if(r>f-e.getDate())r-=f-e.getDate()+1,e.setDate(1),11>o?e.setMonth(o+1):(e.setMonth(0),e.setFullYear(e.getFullYear()+1));else{e.setDate(e.getDate()+r);break}}return e}function un(e,r,o,f){function b(v,q,G){for(v=typeof v=="number"?v.toString():v||"";v.length<q;)v=G[0]+v;return v}function y(v,q){return b(v,q,"0")}function I(v,q){function G($n){return 0>$n?-1:0<$n?1:0}var Fe;return(Fe=G(v.getFullYear()-q.getFullYear()))===0&&(Fe=G(v.getMonth()-q.getMonth()))===0&&(Fe=G(v.getDate()-q.getDate())),Fe}function F(v){switch(v.getDay()){case 0:return new Date(v.getFullYear()-1,11,29);case 1:return v;case 2:return new Date(v.getFullYear(),0,3);case 3:return new Date(v.getFullYear(),0,2);case 4:return new Date(v.getFullYear(),0,1);case 5:return new Date(v.getFullYear()-1,11,31);case 6:return new Date(v.getFullYear()-1,11,30)}}function K(v){v=Ve(new Date(v.da+1900,0,1),v.wa);var q=new Date(v.getFullYear()+1,0,4),G=F(new Date(v.getFullYear(),0,4));return q=F(q),0>=I(G,v)?0>=I(q,v)?v.getFullYear()+1:v.getFullYear():v.getFullYear()-1}var B=u()[f+40>>2];f={Xa:u()[f>>2],Wa:u()[f+4>>2],ua:u()[f+8>>2],oa:u()[f+12>>2],la:u()[f+16>>2],da:u()[f+20>>2],va:u()[f+24>>2],wa:u()[f+28>>2],mb:u()[f+32>>2],Va:u()[f+36>>2],Ya:B?de(B):""},o=de(o),B={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var Q in B)o=o.replace(new RegExp(Q,"g"),B[Q]);var pt="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),Vt="January February March April May June July August September October November December".split(" ");B={"%a":function(v){return pt[v.va].substring(0,3)},"%A":function(v){return pt[v.va]},"%b":function(v){return Vt[v.la].substring(0,3)},"%B":function(v){return Vt[v.la]},"%C":function(v){return y((v.da+1900)/100|0,2)},"%d":function(v){return y(v.oa,2)},"%e":function(v){return b(v.oa,2," ")},"%g":function(v){return K(v).toString().substring(2)},"%G":function(v){return K(v)},"%H":function(v){return y(v.ua,2)},"%I":function(v){return v=v.ua,v==0?v=12:12<v&&(v-=12),y(v,2)},"%j":function(v){return y(v.oa+ft(Ge(v.da+1900)?Pe:De,v.la-1),3)},"%m":function(v){return y(v.la+1,2)},"%M":function(v){return y(v.Wa,2)},"%n":function(){return`
`},"%p":function(v){return 0<=v.ua&&12>v.ua?"AM":"PM"},"%S":function(v){return y(v.Xa,2)},"%t":function(){return"	"},"%u":function(v){return v.va||7},"%U":function(v){var q=new Date(v.da+1900,0,1),G=q.getDay()===0?q:Ve(q,7-q.getDay());return v=new Date(v.da+1900,v.la,v.oa),0>I(G,v)?y(Math.ceil((31-G.getDate()+(ft(Ge(v.getFullYear())?Pe:De,v.getMonth()-1)-31)+v.getDate())/7),2):I(G,q)===0?"01":"00"},"%V":function(v){var q=new Date(v.da+1901,0,4),G=F(new Date(v.da+1900,0,4));q=F(q);var Fe=Ve(new Date(v.da+1900,0,1),v.wa);return 0>I(Fe,G)?"53":0>=I(q,Fe)?"01":y(Math.ceil((G.getFullYear()<v.da+1900?v.wa+32-G.getDate():v.wa+1-G.getDate())/7),2)},"%w":function(v){return v.va},"%W":function(v){var q=new Date(v.da,0,1),G=q.getDay()===1?q:Ve(q,q.getDay()===0?1:7-q.getDay()+1);return v=new Date(v.da+1900,v.la,v.oa),0>I(G,v)?y(Math.ceil((31-G.getDate()+(ft(Ge(v.getFullYear())?Pe:De,v.getMonth()-1)-31)+v.getDate())/7),2):I(G,q)===0?"01":"00"},"%y":function(v){return(v.da+1900).toString().substring(2)},"%Y":function(v){return v.da+1900},"%z":function(v){v=v.Va;var q=0<=v;return v=Math.abs(v)/60,(q?"+":"-")+("0000"+(v/60*100+v%60)).slice(-4)},"%Z":function(v){return v.Ya},"%%":function(){return"%"}};for(Q in B)0<=o.indexOf(Q)&&(o=o.replace(new RegExp(Q,"g"),B[Q](f)));return Q=Ut(o),Q.length>r?0:(wt(Q,e),Q.length-1)}M||k.La();var cn=[null,function(e,r){if(M)return oe(1,1,e,r)},Dt,Nt,Rt,p,at,lt,C,Kt,ut,jt];function Ut(e){var r=Array(et(e)+1);return $e(e,r,0,r.length),r}var ht={c:function(e,r,o,f){ye("Assertion failed: "+de(e)+", at: "+[r?de(r):"unknown filename",o,f?de(f):"unknown function"])},i:Dt,q:Nt,r:Rt,E:function(e,r){if(e==r)postMessage({cmd:"processQueuedMainThreadWork"});else if(M)postMessage({targetThread:e,cmd:"processThreadQueue"});else{if(e=(e=k.ga[e])&&e.worker,!e)return;e.postMessage({cmd:"processThreadQueue"})}return 1},b:function(){ye()},v:function(e,r){if(e===0)e=Date.now();else if(e===1||e===4)e=nt();else return u()[ee()>>2]=28,-1;return u()[r>>2]=e/1e3|0,u()[r+4>>2]=e%1e3*1e6|0,0},n:function(e,r,o){st.length=0;var f;for(o>>=2;f=d()[r++];)(f=105>f)&&o&1&&o++,st.push(f?w()[o++>>1]:u()[o]),++o;return Ot[e].apply(null,st)},z:Lt,m:function(){},f:Ft,e:Ye,g:nt,u:function(e,r,o){d().copyWithin(e,r,r+o)},A:function(e,r,o){it.length=r,o>>=3;for(var f=0;f<r;f++)it[f]=w()[o+f];return(0>e?Ot[-e-1]:cn[e]).apply(null,it)},d:function(e){e>>>=0;var r=d().length;if(e<=r||2147483648<e)return!1;for(var o=1;4>=o;o*=2){var f=r*(1+.2/o);f=Math.min(f,e+100663296),f=Math.max(16777216,e,f),0<f%65536&&(f+=65536-f%65536);e:{try{j.grow(Math.min(2147483648,f)-se.byteLength+65535>>>16),pe(j.buffer);var b=1;break e}catch{}b=void 0}if(b)return!0}return!1},C:function(e,r,o){return ot(e)?qt(e,r,o):p(e,r,o)},l:function(){},D:function(e,r){r>>=2;var o=u()[r+6];if(r={alpha:!!u()[r],depth:!!u()[r+1],stencil:!!u()[r+2],antialias:!!u()[r+3],premultipliedAlpha:!!u()[r+4],preserveDrawingBuffer:!!u()[r+5],powerPreference:Y[o],failIfMajorPerformanceCaveat:!!u()[r+7],Oa:u()[r+8],hb:u()[r+9],Aa:u()[r+10],Ha:u()[r+11],jb:u()[r+12],kb:u()[r+13]},e=ot(e),!e||r.Ha)r=0;else if(e=e.getContext("webgl",r)){o=be(8),u()[o+4>>2]=h();var f={gb:o,attributes:r,version:r.Oa,pa:e};e.canvas&&(e.canvas.qa=f),(typeof r.Aa>"u"||r.Aa)&&A(f),r=o}else r=0;return r},x:at,y:lt,h:function(e){hn(e)},j:C,p:Kt,s:ut,o:jt,t:function(){k.Ma()},a:j||i.wasmMemory,k:function(e,r,o,f){if(typeof SharedArrayBuffer>"u")return U("Current environment does not support SharedArrayBuffer, pthreads are not available!"),6;if(!e)return U("pthread_create called with a null thread pointer!"),28;var b=[];if(M&&b.length===0)return L(687865856,e,r,o,f);var y=0,I=0;if(r&&r!=-1){var F=u()[r>>2];F+=81920,y=u()[r+8>>2],I=u()[r+12>>2]!==0}else F=2097152;(r=y==0)?y=Cn(16,F):(y-=F,Ie(0<y));for(var K=be(228),B=0;57>B;++B)_()[(K>>2)+B]=0;return u()[e>>2]=K,u()[K+12>>2]=K,e=K+152,u()[e>>2]=e,o={ja:y,ka:F,xa:r,detached:I,Sa:o,sa:K,ma:f,Za:b},M?(o.ab="spawnThread",postMessage(o,b)):ct(o),0},B:function(e,r){return ln(e,r)},w:function(e,r,o,f){return un(e,r,o,f)}};(function(){function e(b,y){if(i.asm=b.exports,We=i.asm.ca,bt=y,!M){var I=k.fa.length;k.fa.forEach(function(F){k.Ba(F,function(){if(!--I&&(ge--,i.monitorRunDependencies&&i.monitorRunDependencies(ge),ge==0&&Me)){var K=Me;Me=null,K()}})})}}function r(b){e(b.instance,b.module)}function o(b){return sn().then(function(y){return WebAssembly.instantiate(y,f)}).then(b,function(y){U("failed to asynchronously prepare wasm: "+y),ye(y)})}var f={a:ht};if(M||(Ie(!M,"addRunDependency cannot be used in a pthread worker"),ge++,i.monitorRunDependencies&&i.monitorRunDependencies(ge)),i.instantiateWasm)try{return i.instantiateWasm(f,e)}catch(b){return U("Module.instantiateWasm callback failed with error: "+b),!1}return(function(){return Ee||typeof WebAssembly.instantiateStreaming!="function"||Tt()||typeof fetch!="function"?o(r):fetch(he,{credentials:"same-origin"}).then(function(b){return WebAssembly.instantiateStreaming(b,f).then(r,function(y){return U("wasm streaming compile failed: "+y),U("falling back to ArrayBuffer instantiation"),o(r)})})})().catch(E),{}})();var Wt=i.___wasm_call_ctors=function(){return(Wt=i.___wasm_call_ctors=i.asm.F).apply(null,arguments)};i._main=function(){return(i._main=i.asm.G).apply(null,arguments)};var be=i._malloc=function(){return(be=i._malloc=i.asm.H).apply(null,arguments)},Ne=i._free=function(){return(Ne=i._free=i.asm.I).apply(null,arguments)};i._uci_command=function(){return(i._uci_command=i.asm.J).apply(null,arguments)};var Ht=i._emscripten_get_global_libc=function(){return(Ht=i._emscripten_get_global_libc=i.asm.K).apply(null,arguments)},ee=i.___errno_location=function(){return(ee=i.___errno_location=i.asm.L).apply(null,arguments)};i.___em_js__initPthreadsJS=function(){return(i.___em_js__initPthreadsJS=i.asm.M).apply(null,arguments)};var h=i._pthread_self=function(){return(h=i._pthread_self=i.asm.N).apply(null,arguments)},g=i.___pthread_tsd_run_dtors=function(){return(g=i.___pthread_tsd_run_dtors=i.asm.O).apply(null,arguments)};i._emscripten_current_thread_process_queued_calls=function(){return(i._emscripten_current_thread_process_queued_calls=i.asm.P).apply(null,arguments)};var m=i._emscripten_register_main_browser_thread_id=function(){return(m=i._emscripten_register_main_browser_thread_id=i.asm.Q).apply(null,arguments)},x=i._emscripten_main_browser_thread_id=function(){return(x=i._emscripten_main_browser_thread_id=i.asm.R).apply(null,arguments)},$=i.__emscripten_do_dispatch_to_thread=function(){return($=i.__emscripten_do_dispatch_to_thread=i.asm.S).apply(null,arguments)},L=i._emscripten_sync_run_in_main_thread_4=function(){return(L=i._emscripten_sync_run_in_main_thread_4=i.asm.T).apply(null,arguments)},ce=i._emscripten_main_thread_process_queued_calls=function(){return(ce=i._emscripten_main_thread_process_queued_calls=i.asm.U).apply(null,arguments)},Re=i._emscripten_run_in_main_runtime_thread_js=function(){return(Re=i._emscripten_run_in_main_runtime_thread_js=i.asm.V).apply(null,arguments)},kn=i.__emscripten_call_on_thread=function(){return(kn=i.__emscripten_call_on_thread=i.asm.W).apply(null,arguments)};i._emscripten_tls_init=function(){return(i._emscripten_tls_init=i.asm.X).apply(null,arguments)};var Yt=i.__emscripten_thread_init=function(){return(Yt=i.__emscripten_thread_init=i.asm.Y).apply(null,arguments)},Qt=i.stackSave=function(){return(Qt=i.stackSave=i.asm.Z).apply(null,arguments)},dt=i.stackRestore=function(){return(dt=i.stackRestore=i.asm._).apply(null,arguments)},Le=i.stackAlloc=function(){return(Le=i.stackAlloc=i.asm.$).apply(null,arguments)},Sn=i._emscripten_stack_set_limits=function(){return(Sn=i._emscripten_stack_set_limits=i.asm.aa).apply(null,arguments)},Cn=i._memalign=function(){return(Cn=i._memalign=i.asm.ba).apply(null,arguments)},xn=i.__emscripten_allow_main_runtime_queued_calls=25580,ze=i.__emscripten_main_thread_futex=1088592;i.ccall=function(e,r,o,f){var b={string:function(B){var Q=0;if(B!=null&&B!==0){var pt=(B.length<<2)+1,Vt=Q=Le(pt);$e(B,d(),Vt,pt)}return Q},array:function(B){var Q=Le(B.length);return wt(B,Q),Q}},y=tn(e),I=[];if(e=0,f)for(var F=0;F<f.length;F++){var K=b[o[F]];K?(e===0&&(e=Qt()),I[F]=K(f[F])):I[F]=f[F]}return o=y.apply(null,I),o=(function(B){return r==="string"?de(B):r==="boolean"?!!B:B})(o),e!==0&&dt(e),o},i.PThread=k,i.PThread=k,i.wasmMemory=j,i.ExitStatus=Je;var Gt;function Je(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}Me=function e(){Gt||fn(),Gt||(Me=e)};function fn(e){function r(){if(!Gt&&(Gt=!0,i.calledRun=!0,!je)){if(He(It),M||He(nn),T(i),i.onRuntimeInitialized&&i.onRuntimeInitialized(),In){var o=e,f=i._main;o=o||[];var b=o.length+1,y=Le(4*(b+1));u()[y>>2]=Te(H);for(var I=1;I<b;I++)u()[(y>>2)+I]=Te(o[I-1]);u()[(y>>2)+b]=0;try{var F=f(b,y);hn(F,!0)}catch(K){K instanceof Je||(K=="unwind"?ve=!0:((o=K)&&typeof K=="object"&&K.stack&&(o=[K,K.stack]),U("exception thrown: "+o),W(1,K)))}finally{}}if(!M){if(i.postRun)for(typeof i.postRun=="function"&&(i.postRun=[i.postRun]);i.postRun.length;)o=i.postRun.shift(),$t.unshift(o);He($t)}}}if(e=e||R,!(0<ge))if(M)T(i),postMessage({cmd:"loaded"});else{if(!M){if(i.preRun)for(typeof i.preRun=="function"&&(i.preRun=[i.preRun]);i.preRun.length;)rn();He(tt)}0<ge||(i.setStatus?(i.setStatus("Running..."),setTimeout(function(){setTimeout(function(){i.setStatus("")},1),r()},1)):r())}}i.run=fn;function hn(e,r){if(!r||!ve||e!==0){if(!r&&M)throw postMessage({cmd:"exitProcess",returnCode:e}),new Je(e);ve||(k.Ea(),i.onExit&&i.onExit(e),je=!0),W(e,new Je(e))}}if(i.preInit)for(typeof i.preInit=="function"&&(i.preInit=[i.preInit]);0<i.preInit.length;)i.preInit.pop()();var In=!0;return i.noInitialRun&&(In=!1),ve=!M,M&&k.Na(),fn(),l.ready})})();a.exports=t})(bn)),bn.exports}var dr=hr();const pr=lr(dr);async function gr(a,n){const t=await pr(),s=new ar;s.loadPgn(a);let l=0;const c=s.history();for(let d=0;d<c.length;d++){const _=(d+1)%2===1;if(n==="white"&&!_||n==="black"&&_){s.move(c[d]);continue}s.undo();const w=s.fen();s.move(c[d]);const i=s.fen(),T=await Rn(t,w),E=await Rn(t,i);(n==="white"?E-T:T-E)<-500&&l++}return l}async function Rn(a,n){return new Promise(t=>{a.postMessage(`position fen ${n}`),a.postMessage("go depth 8"),a.onmessage=s=>{const l=s.data;if(l.startsWith("info depth")){const c=l.match(/score cp (-?\d+)/);c&&t(parseInt(c[1]))}else l.includes("mate")&&t(1e4)}})}function wn(a){const n=document.getElementById("loading"),t=document.getElementById("stats"),s=document.getElementById("graphs-container");n&&(n.style.display=a?"flex":"none",s.style.display=a?"none":"flex",t.style.display=a?"none":"flex")}function mr(a){const n=a.length;let t=0,s=0,l=0,c=0,d=0,u=0,_=0,w=0,i=0,T=0,E=0,S=0;if(n===0)return null;const D=a[0].kris_rating,H=a[a.length-1].kris_rating-D;a.forEach(N=>{N.kris_result==="win"?(t++,N.opp_result==="resigned"&&_++,N.opp_result==="checkmated"&&w++,N.opp_result==="timeout"&&i++,N.opp_result==="abandoned"&&T++):N.kris_result==="repetition"||N.kris_result==="agreed"||N.kris_result==="stalemate"||N.kris_result==="insufficient"||N.kris_result==="timevsinsufficient"?s++:N.opp_result==="win"&&(l++,N.kris_result==="resigned"&&E++,N.kris_result==="checkmated"&&S++,N.kris_result==="timeout"&&c++,N.kris_result==="abandoned"&&d++);const z=gr(N.pgn_results,N.kris_color);u+=z});const W=(t/n*100).toFixed(2);return{num_games:n,wins:t,draws:s,losses:l,timeouts:c,abandoned:d,opp_resigned:_,opp_checkmated:w,opp_timeout:i,opp_abandoned:T,resigned:E,checkmated:S,win_rate:W,elo_change:H,tot_blunders:u}}function _r(a,n,t){if(!a)return;console.log("blunders:",a.tot_blunders);const s=[a.opp_resigned>0?`${a.opp_resigned} resignations`:null,a.opp_checkmated>0?`${a.opp_checkmated} checkmates`:null,a.opp_timeout>0?`${a.opp_timeout} timeouts`:null,a.opp_abandoned>0?`${a.opp_abandoned} abandoned`:null].filter(Boolean).join(", "),l=[a.resigned>0?`${a.resigned} resignations`:null,a.checkmated>0?`${a.checkmated} checkmates`:null,a.timeouts>0?`${a.timeouts} timeouts`:null,a.abandoned>0?`${a.abandoned} abandoned`:null].filter(Boolean).join(", "),c=[a.draws>0?`, drew ${a.draws} games`:null].filter(Boolean).join(", ");document.getElementById("stats").innerHTML=`
    <p id="games-played">${t} played ${a.num_games} games in ${n}.</p>
  <p id="wins-losses">They won ${a.wins} games (${s}) ${c} and lost ${a.losses} games (${l}).</p>
  <p id="win-rate">That's a win rate of ${a.win_rate}%.</p>
  <p id="elo-change">Their ELO change over the month was: ${a.elo_change}</p>`}async function vr(a,n,t){try{const s=await fetch(`https://blunderstruck.onrender.com/api/month/?username=${a}&month=${n}&year=${t}`);if(console.log("Fetch status:",s.status),s.status===404)return{error:"user doesn't exist"};if(s.status===200)return{message:"found user"}}catch(s){return console.error("Error in fetchRecentMonths:",s),[]}}async function yr(a,n,t){try{const s=await fetch(`https://blunderstruck.onrender.com/api/month/?username=${a}&month=${n}&year=${t}`);if(console.log("Fetch status:",s.status),!s.ok)return console.warn("Non-OK response from server"),[];const l=await s.json();if(!l||!Array.isArray(l.games))return console.warn("No valid games array found in response:",l),[];const c=l.games.flatMap(d=>Array.isArray(d)?d:[d]);return console.log("Flattened games:",c.length),c}catch(s){return console.error("Error in fetchRecentMonths:",s),[]}}function br(a,n){const t=a.white.username.toLowerCase()===n,s=t?a.white:a.black,l=t?a.black:a.white,c=new Date(a.end_time*1e3);let d="";if(a.eco){const u=a.eco,w=(t?u.split("/").pop():"").replace(/-/g," ").replace(/\d+\./g,"").trim(),i=w.split(" ");i.length>4?d=i.slice(0,4).join(" ")+"...":d=w}return{chesscom_id:a.url?.split("/").pop()||null,date:c,dateStr:c.toISOString().slice(0,10),end_time:a.end_time,time_control:a.time_control,kris_color:t?"white":"black",kris_rating:s.rating,opp_rating:l.rating,kris_result:s.result,opp_result:l.result,opening:d,pgn_results:a.pgn||null}}function wr(a){const n={};for(const _ of a)n[_.dateStr]=_.kris_rating;const t=[],s=[],l=new Date(a[0].dateStr),c=new Date(a[a.length-1].dateStr);for(let _=new Date(l);_<=c;_.setDate(_.getDate()+1)){const w=_.toISOString().slice(0,10),i=w in n?n[w]:null;t.push(w),s.push(i)}let d=null;const u=s.map(_=>_!=null?(d=_,_):d);return{days:t,ratings:u}}function Er(a){const{days:n,ratings:t}=wr(a),s=["January","February","March","April","May","June","July","August","September","October","November","December"],l=document.getElementById("ratingChart"),c={labels:n,datasets:[{label:"Rating Over Time",data:t,borderColor:"rgba(54, 162, 235, 1)",borderWidth:2,tension:.3,fill:!1,pointRadius:3}]},d={scales:{x:{title:{display:!0,text:(()=>{if(n.length>0){const u=new Date(n[0]);return`${s[u.getMonth()]} ${u.getFullYear()}`}return""})(),font:{size:14}},ticks:{callback:function(u,_){return new Date(n[_]).getDate()}}},y:{beginAtZero:!1,title:{display:!0,text:"ELO",font:{size:20}}}},plugins:{legend:{display:!1,position:"bottom"}}};return new Chart(l,{type:"line",data:c,options:d})}function Ar(a){const n={};a.forEach(s=>{s.opening&&(n[s.opening]=(n[s.opening]||0)+1)});let t=0;a.length>100?t=5:t=2;for(const s in n)n[s]<t&&delete n[s];return n}function kr(a){const n=Ar(a),t=Object.keys(n),s=Object.values(n),l=document.getElementById("openingsChart").getContext("2d"),c={labels:t,datasets:[{label:"Times Played",data:s,backgroundColor:"rgba(54, 162, 235, 0.5)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1}]},d={indexAxis:"y",scales:{x:{title:{display:!0,text:"Number of Games"},beginAtZero:!0},y:{title:{display:!0,text:"Opening"}}},plugins:{legend:{display:!1}}};return new Chart(l,{type:"bar",data:c,options:d})}async function Sr(a){const n=document.getElementById("stats"),t=document.getElementById("graphs-container");n.style.display="none",t.style.display="none",document.getElementById("stats").innerHTML="";const s=document.getElementById("controls");a=document.getElementById("usernameInput").value.trim();const d=new Date().getFullYear(),u=new Date().getMonth()+1;console.log("Username set:",a);const _=document.getElementById("message");_.style.display="none";const w=document.getElementById("no-user-message");if(w.style.display="none",(await vr(a,u,d)).error){w.style.display="block";return}s.style.display="inline-block";const T=document.getElementById("yearSelect"),E=document.getElementById("monthSelect"),S=document.getElementById("loadButton");if(document.querySelectorAll("option").length<1){for(let W=d;W>=2020;W--){const N=document.createElement("option");N.value=W,N.textContent=W,T.appendChild(N)}["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((W,N)=>{const z=document.createElement("option");z.value=N+1,z.textContent=W,E.appendChild(z)})}T.value=d,E.value=u;const R=S.cloneNode(!0);S.parentNode.replaceChild(R,S),R.addEventListener("click",async()=>{const H=T.value,W=E.value;console.log("fetching for",a),console.log(W),wn(!0);try{const N=await yr(a,W,H);console.log("Fetched raw data:",N.length);const z=(N||[]).filter(M=>M.rated===!0);console.log("Found rated games:",z.length);const X=z.map(M=>br(M,a)).sort((M,J)=>M.end_time-J.end_time);if(console.log("Normalised games:",X.length),wn(!1),!X||X.length===0)t.style.display="none",document.getElementById("stats").innerHTML="<p>Sorry, no games found for this month. Please select a different month.</p>",console.log("no games found for this month");else{t.style.display="flex";const M=new Date(H,W-1).toLocaleString("default",{month:"long"}),J=mr(X);_r(J,M,a),window.eloChartInstance&&window.eloChartInstance.destroy(),window.openingsChartInstance&&window.openingsChartInstance.destroy(),window.eloChartInstance=Er(X),window.openingsChartInstance=kr(X)}}catch(N){return console.error("Error in deploying:",N),wn(!1),[]}}),R.click()}document.addEventListener("DOMContentLoaded",async()=>{console.log("DOMContentLoaded fired ");let a=null;const n=document.getElementById("search-button"),t=document.getElementById("usernameInput"),s=document.getElementById("message"),l=document.getElementById("stats");document.querySelectorAll(".hidden-on-load").forEach(d=>d.style.display="none"),l.style.display="none",s.style.display="block",n.addEventListener("click",async()=>{n.disabled=!0,n.style.display="none",await Sr(a)}),t.addEventListener("focus",async()=>{n.disabled=!1,n.style.display="inline-block"})});
