(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();function ts(n){return n!==null?{comment:n,variations:[]}:{variations:[]}}function ss(n,t,e,s,i){const r={move:n,variations:i};return t&&(r.suffix=t),e&&(r.nag=e),s!==null&&(r.comment=s),r}function ns(...n){const[t,...e]=n;let s=t;for(const i of e)i!==null&&(s.variations=[i,...i.variations],i.variations=[],s=i);return t}function is(n,t){if(t.marker&&t.marker.comment){let e=t.root;for(;;){const s=e.variations[0];if(!s){e.comment=t.marker.comment;break}e=s}}return{headers:n,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function rs(n,t){function e(){this.constructor=n}e.prototype=t.prototype,n.prototype=new e}function Z(n,t,e,s){var i=Error.call(this,n);return Object.setPrototypeOf&&Object.setPrototypeOf(i,Z.prototype),i.expected=t,i.found=e,i.location=s,i.name="SyntaxError",i}rs(Z,Error);function ge(n,t,e){return e=e||" ",n.length>t?n:(t-=n.length,e+=e.repeat(t),n+e.slice(0,t))}Z.prototype.format=function(n){var t="Error: "+this.message;if(this.location){var e=null,s;for(s=0;s<n.length;s++)if(n[s].source===this.location.source){e=n[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,r=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,a=this.location.source+":"+r.line+":"+r.column;if(e){var h=this.location.end,u=ge("",r.line.toString().length," "),p=e[i.line-1],_=i.line===h.line?h.column:p.length+1,E=_-i.column||1;t+=`
 --> `+a+`
`+u+` |
`+r.line+" | "+p+`
`+u+" | "+ge("",i.column-1," ")+ge("",E,"^")}else t+=`
 at `+a}return t};Z.buildMessage=function(n,t){var e={literal:function(p){return'"'+i(p.text)+'"'},class:function(p){var _=p.parts.map(function(E){return Array.isArray(E)?r(E[0])+"-"+r(E[1]):r(E)});return"["+(p.inverted?"^":"")+_.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(p){return p.description}};function s(p){return p.charCodeAt(0).toString(16).toUpperCase()}function i(p){return p.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(_){return"\\x0"+s(_)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(_){return"\\x"+s(_)})}function r(p){return p.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(_){return"\\x0"+s(_)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(_){return"\\x"+s(_)})}function a(p){return e[p.type](p)}function h(p){var _=p.map(a),E,d;if(_.sort(),_.length>0){for(E=1,d=1;E<_.length;E++)_[E-1]!==_[E]&&(_[d]=_[E],d++);_.length=d}switch(_.length){case 1:return _[0];case 2:return _[0]+" or "+_[1];default:return _.slice(0,-1).join(", ")+", or "+_[_.length-1]}}function u(p){return p?'"'+i(p)+'"':"end of input"}return"Expected "+h(n)+" but "+u(t)+" found."};function os(n,t){t=t!==void 0?t:{};var e={},s=t.grammarSource,i={pgn:Ue},r=Ue,a="[",h='"',u="]",p=".",_="O-O-O",E="O-O",d="0-0-0",m="0-0",k="$",w="{",L="}",O=";",$="(",q=")",j="1-0",B="0-1",J="1/2-1/2",et="*",ue=/^[a-zA-Z]/,$e=/^[^"]/,ne=/^[0-9]/,Ae=/^[.]/,we=/^[a-zA-Z1-8\-=]/,tt=/^[+#]/,Ie=/^[!?]/,Te=/^[^}]/,Ne=/^[^\r\n]/,Pe=/^[ \t\r\n]/,st=F("tag pair"),nt=N("[",!1),xe=N('"',!1),it=N("]",!1),rt=F("tag name"),pe=U([["a","z"],["A","Z"]],!1,!1),ot=F("tag value"),Oe=U(['"'],!0,!1),at=F("move number"),ie=U([["0","9"]],!1,!1),lt=N(".",!1),Me=U(["."],!1,!1),ct=F("standard algebraic notation"),ft=N("O-O-O",!1),ht=N("O-O",!1),ut=N("0-0-0",!1),pt=N("0-0",!1),Le=U([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),dt=U(["+","#"],!1,!1),gt=F("suffix annotation"),Ke=U(["!","?"],!1,!1),_t=F("NAG"),mt=N("$",!1),bt=F("brace comment"),vt=N("{",!1),De=U(["}"],!0,!1),yt=N("}",!1),Et=F("rest of line comment"),St=N(";",!1),Fe=U(["\r",`
`],!0,!1),Ct=F("variation"),kt=N("(",!1),$t=N(")",!1),At=F("game termination marker"),wt=N("1-0",!1),It=N("0-1",!1),Tt=N("1/2-1/2",!1),Nt=N("*",!1),Pt=F("whitespace"),Re=U([" ","	","\r",`
`],!1,!1),xt=function(o,c){return is(o,c)},Ot=function(o){return Object.fromEntries(o)},Mt=function(o,c){return[o,c]},Lt=function(o,c){return{root:o,marker:c}},Kt=function(o,c){return ns(ts(o),...c.flat())},Dt=function(o,c,f,v,y){return ss(o,c,f,v,y)},Ft=function(o){return o},Rt=function(o){return o.replace(/[\r\n]+/g," ")},qt=function(o){return o.trim()},Bt=function(o){return o},Ut=function(o,c){return{result:o,comment:c}},l=t.peg$currPos|0,z=[{line:1,column:1}],R=l,re=t.peg$maxFailExpected||[],g=t.peg$silentFails|0,X;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');r=i[t.startRule]}function N(o,c){return{type:"literal",text:o,ignoreCase:c}}function U(o,c,f){return{type:"class",parts:o,inverted:c,ignoreCase:f}}function jt(){return{type:"end"}}function F(o){return{type:"other",description:o}}function qe(o){var c=z[o],f;if(c)return c;if(o>=z.length)f=z.length-1;else for(f=o;!z[--f];);for(c=z[f],c={line:c.line,column:c.column};f<o;)n.charCodeAt(f)===10?(c.line++,c.column=1):c.column++,f++;return z[o]=c,c}function Be(o,c,f){var v=qe(o),y=qe(c),A={source:s,start:{offset:o,line:v.line,column:v.column},end:{offset:c,line:y.line,column:y.column}};return A}function b(o){l<R||(l>R&&(R=l,re=[]),re.push(o))}function Qt(o,c,f){return new Z(Z.buildMessage(o,c),o,c,f)}function Ue(){var o,c,f;return o=l,c=Ht(),f=Vt(),o=xt(c,f),o}function Ht(){var o,c,f;for(o=l,c=[],f=je();f!==e;)c.push(f),f=je();return f=K(),o=Ot(c),o}function je(){var o,c,f,v,y,A,G;return g++,o=l,K(),n.charCodeAt(l)===91?(c=a,l++):(c=e,g===0&&b(nt)),c!==e?(K(),f=Wt(),f!==e?(K(),n.charCodeAt(l)===34?(v=h,l++):(v=e,g===0&&b(xe)),v!==e?(y=Gt(),n.charCodeAt(l)===34?(A=h,l++):(A=e,g===0&&b(xe)),A!==e?(K(),n.charCodeAt(l)===93?(G=u,l++):(G=e,g===0&&b(it)),G!==e?o=Mt(f,y):(l=o,o=e)):(l=o,o=e)):(l=o,o=e)):(l=o,o=e)):(l=o,o=e),g--,o===e&&g===0&&b(st),o}function Wt(){var o,c,f;if(g++,o=l,c=[],f=n.charAt(l),ue.test(f)?l++:(f=e,g===0&&b(pe)),f!==e)for(;f!==e;)c.push(f),f=n.charAt(l),ue.test(f)?l++:(f=e,g===0&&b(pe));else c=e;return c!==e?o=n.substring(o,l):o=c,g--,o===e&&(c=e,g===0&&b(rt)),o}function Gt(){var o,c,f;for(g++,o=l,c=[],f=n.charAt(l),$e.test(f)?l++:(f=e,g===0&&b(Oe));f!==e;)c.push(f),f=n.charAt(l),$e.test(f)?l++:(f=e,g===0&&b(Oe));return o=n.substring(o,l),g--,c=e,g===0&&b(ot),o}function Vt(){var o,c,f;return o=l,c=Qe(),K(),f=es(),f===e&&(f=null),K(),o=Lt(c,f),o}function Qe(){var o,c,f,v;for(o=l,c=de(),c===e&&(c=null),f=[],v=He();v!==e;)f.push(v),v=He();return o=Kt(c,f),o}function He(){var o,c,f,v,y,A,G,oe;if(o=l,K(),Yt(),K(),c=Jt(),c!==e){for(f=zt(),f===e&&(f=null),v=[],y=We();y!==e;)v.push(y),y=We();for(y=K(),A=de(),A===e&&(A=null),G=[],oe=Ge();oe!==e;)G.push(oe),oe=Ge();o=Dt(c,f,v,A,G)}else l=o,o=e;return o}function Yt(){var o,c,f,v,y,A;for(g++,o=l,c=[],f=n.charAt(l),ne.test(f)?l++:(f=e,g===0&&b(ie));f!==e;)c.push(f),f=n.charAt(l),ne.test(f)?l++:(f=e,g===0&&b(ie));if(n.charCodeAt(l)===46?(f=p,l++):(f=e,g===0&&b(lt)),f!==e){for(v=K(),y=[],A=n.charAt(l),Ae.test(A)?l++:(A=e,g===0&&b(Me));A!==e;)y.push(A),A=n.charAt(l),Ae.test(A)?l++:(A=e,g===0&&b(Me));c=[c,f,v,y],o=c}else l=o,o=e;return g--,o===e&&(c=e,g===0&&b(at)),o}function Jt(){var o,c,f,v,y,A;if(g++,o=l,c=l,n.substr(l,5)===_?(f=_,l+=5):(f=e,g===0&&b(ft)),f===e&&(n.substr(l,3)===E?(f=E,l+=3):(f=e,g===0&&b(ht)),f===e&&(n.substr(l,5)===d?(f=d,l+=5):(f=e,g===0&&b(ut)),f===e&&(n.substr(l,3)===m?(f=m,l+=3):(f=e,g===0&&b(pt)),f===e))))if(f=l,v=n.charAt(l),ue.test(v)?l++:(v=e,g===0&&b(pe)),v!==e){if(y=[],A=n.charAt(l),we.test(A)?l++:(A=e,g===0&&b(Le)),A!==e)for(;A!==e;)y.push(A),A=n.charAt(l),we.test(A)?l++:(A=e,g===0&&b(Le));else y=e;y!==e?(v=[v,y],f=v):(l=f,f=e)}else l=f,f=e;return f!==e?(v=n.charAt(l),tt.test(v)?l++:(v=e,g===0&&b(dt)),v===e&&(v=null),f=[f,v],c=f):(l=c,c=e),c!==e?o=n.substring(o,l):o=c,g--,o===e&&(c=e,g===0&&b(ct)),o}function zt(){var o,c,f;for(g++,o=l,c=[],f=n.charAt(l),Ie.test(f)?l++:(f=e,g===0&&b(Ke));f!==e;)c.push(f),c.length>=2?f=e:(f=n.charAt(l),Ie.test(f)?l++:(f=e,g===0&&b(Ke)));return c.length<1?(l=o,o=e):o=c,g--,o===e&&(c=e,g===0&&b(gt)),o}function We(){var o,c,f,v,y;if(g++,o=l,K(),n.charCodeAt(l)===36?(c=k,l++):(c=e,g===0&&b(mt)),c!==e){if(f=l,v=[],y=n.charAt(l),ne.test(y)?l++:(y=e,g===0&&b(ie)),y!==e)for(;y!==e;)v.push(y),y=n.charAt(l),ne.test(y)?l++:(y=e,g===0&&b(ie));else v=e;v!==e?f=n.substring(f,l):f=v,f!==e?o=Ft(f):(l=o,o=e)}else l=o,o=e;return g--,o===e&&g===0&&b(_t),o}function de(){var o;return o=Zt(),o===e&&(o=Xt()),o}function Zt(){var o,c,f,v,y;if(g++,o=l,n.charCodeAt(l)===123?(c=w,l++):(c=e,g===0&&b(vt)),c!==e){for(f=l,v=[],y=n.charAt(l),Te.test(y)?l++:(y=e,g===0&&b(De));y!==e;)v.push(y),y=n.charAt(l),Te.test(y)?l++:(y=e,g===0&&b(De));f=n.substring(f,l),n.charCodeAt(l)===125?(v=L,l++):(v=e,g===0&&b(yt)),v!==e?o=Rt(f):(l=o,o=e)}else l=o,o=e;return g--,o===e&&(c=e,g===0&&b(bt)),o}function Xt(){var o,c,f,v,y;if(g++,o=l,n.charCodeAt(l)===59?(c=O,l++):(c=e,g===0&&b(St)),c!==e){for(f=l,v=[],y=n.charAt(l),Ne.test(y)?l++:(y=e,g===0&&b(Fe));y!==e;)v.push(y),y=n.charAt(l),Ne.test(y)?l++:(y=e,g===0&&b(Fe));f=n.substring(f,l),o=qt(f)}else l=o,o=e;return g--,o===e&&(c=e,g===0&&b(Et)),o}function Ge(){var o,c,f,v;return g++,o=l,K(),n.charCodeAt(l)===40?(c=$,l++):(c=e,g===0&&b(kt)),c!==e?(f=Qe(),f!==e?(K(),n.charCodeAt(l)===41?(v=q,l++):(v=e,g===0&&b($t)),v!==e?o=Bt(f):(l=o,o=e)):(l=o,o=e)):(l=o,o=e),g--,o===e&&g===0&&b(Ct),o}function es(){var o,c,f;return g++,o=l,n.substr(l,3)===j?(c=j,l+=3):(c=e,g===0&&b(wt)),c===e&&(n.substr(l,3)===B?(c=B,l+=3):(c=e,g===0&&b(It)),c===e&&(n.substr(l,7)===J?(c=J,l+=7):(c=e,g===0&&b(Tt)),c===e&&(n.charCodeAt(l)===42?(c=et,l++):(c=e,g===0&&b(Nt))))),c!==e?(K(),f=de(),f===e&&(f=null),o=Ut(c,f)):(l=o,o=e),g--,o===e&&(c=e,g===0&&b(At)),o}function K(){var o,c;for(g++,o=[],c=n.charAt(l),Pe.test(c)?l++:(c=e,g===0&&b(Re));c!==e;)o.push(c),c=n.charAt(l),Pe.test(c)?l++:(c=e,g===0&&b(Re));return g--,c=e,g===0&&b(Pt),o}if(X=r(),t.peg$library)return{peg$result:X,peg$currPos:l,peg$FAILED:e,peg$maxFailExpected:re,peg$maxFailPos:R};if(X!==e&&l===n.length)return X;throw X!==e&&l<n.length&&b(jt()),Qt(re,R<n.length?n.charAt(R):null,R<n.length?Be(R,R+1):Be(R,R))}const ce=0xffffffffffffffffn;function _e(n,t){return(n<<t|n>>64n-t)&0xffffffffffffffffn}function Ve(n,t){return n*t&ce}function as(n){return function(){let t=BigInt(n&ce),e=BigInt(n>>64n&ce);const s=Ve(_e(Ve(t,5n),7n),9n);return e^=t,t=(_e(t,24n)^e^e<<16n)&ce,e=_e(e,37n),n=e<<64n|t,s}}const he=as(0xa187eb39cdcaed8f31c4b365b102e01en),ls=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>he()))),cs=Array.from({length:8},()=>he()),fs=Array.from({length:16},()=>he()),me=he(),M="w",D="b",I="p",Ce="n",fe="b",te="r",W="q",T="k",be="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class ae{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,e){const{color:s,piece:i,from:r,to:a,flags:h,captured:u,promotion:p}=e,_=P(r),E=P(a);this.color=s,this.piece=i,this.from=_,this.to=E,this.san=t._moveToSan(e,t._moves({legal:!0})),this.lan=_+E,this.before=t.fen(),t._makeMove(e),this.after=t.fen(),t._undoMove(),this.flags="";for(const d in C)C[d]&h&&(this.flags+=V[d]);u&&(this.captured=u),p&&(this.promotion=p,this.lan+=p)}isCapture(){return this.flags.indexOf(V.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(V.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(V.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(V.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(V.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(V.BIG_PAWN)>-1}}const x=-1,V={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},C={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},ke={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},hs={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},us={...ke,...hs},S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ve={b:[16,32,17,15],w:[-16,-32,-17,-15]},Ye={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ps=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],ds=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],gs={p:1,n:2,b:4,r:8,q:16,k:32},_s="pnbrqkPNBRQK",Je=[Ce,fe,te,W],ms=7,bs=6,vs=1,ys=0,le={[T]:C.KSIDE_CASTLE,[W]:C.QSIDE_CASTLE},Q={w:[{square:S.a1,flag:C.QSIDE_CASTLE},{square:S.h1,flag:C.KSIDE_CASTLE}],b:[{square:S.a8,flag:C.QSIDE_CASTLE},{square:S.h8,flag:C.KSIDE_CASTLE}]},Es={b:vs,w:bs},ye="--";function Y(n){return n>>4}function se(n){return n&15}function Xe(n){return"0123456789".indexOf(n)!==-1}function P(n){const t=se(n),e=Y(n);return"abcdefgh".substring(t,t+1)+"87654321".substring(e,e+1)}function ee(n){return n===M?D:M}function Ss(n){const t=n.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const e=parseInt(t[5],10);if(isNaN(e)||e<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const s=parseInt(t[4],10);if(isNaN(s)||s<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let a=0;a<i.length;a++){let h=0,u=!1;for(let p=0;p<i[a].length;p++)if(Xe(i[a][p])){if(u)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};h+=parseInt(i[a][p],10),u=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[a][p]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};h+=1,u=!1}if(h!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const r=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:a,regex:h}of r){if(!h.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${a} king`};if((t[0].match(h)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${a} kings`}}return Array.from(i[0]+i[7]).some(a=>a.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Cs(n,t){const e=n.from,s=n.to,i=n.piece;let r=0,a=0,h=0;for(let u=0,p=t.length;u<p;u++){const _=t[u].from,E=t[u].to,d=t[u].piece;i===d&&e!==_&&s===E&&(r++,Y(e)===Y(_)&&a++,se(e)===se(_)&&h++)}return r>0?a>0&&h>0?P(e):h>0?P(e).charAt(1):P(e).charAt(0):""}function H(n,t,e,s,i,r=void 0,a=C.NORMAL){const h=Y(s);if(i===I&&(h===ms||h===ys))for(let u=0;u<Je.length;u++){const p=Je[u];n.push({color:t,from:e,to:s,piece:i,captured:r,promotion:p,flags:a|C.PROMOTION})}else n.push({color:t,from:e,to:s,piece:i,captured:r,flags:a})}function ze(n){let t=n.charAt(0);return t>="a"&&t<="h"?n.match(/[a-h]\d.*[a-h]\d/)?void 0:I:(t=t.toLowerCase(),t==="o"?T:t)}function Ee(n){return n.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class ks{_board=new Array(128);_turn=M;_header={};_kings={w:x,b:x};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=be,{skipValidation:e=!1}={}){this.load(t,{skipValidation:e})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:x,b:x},this._turn=M,this._castling={w:0,b:0},this._epSquare=x,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...us},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:e=!1,preserveHeaders:s=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const h=["-","-","0","1"];t=i.concat(h.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!e){const{ok:h,error:u}=Ss(t);if(!h)throw new Error(u)}const r=i[0];let a=0;this.clear({preserveHeaders:s});for(let h=0;h<r.length;h++){const u=r.charAt(h);if(u==="/")a+=8;else if(Xe(u))a+=parseInt(u,10);else{const p=u<"a"?M:D;this._put({type:u.toLowerCase(),color:p},P(a)),a++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=C.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=C.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=C.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=C.QSIDE_CASTLE),this._epSquare=i[3]==="-"?x:S[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let e=0,s="";for(let a=S.a8;a<=S.h1;a++){if(this._board[a]){e>0&&(s+=e,e=0);const{color:h,type:u}=this._board[a];s+=h===M?u.toUpperCase():u.toLowerCase()}else e++;a+1&136&&(e>0&&(s+=e),a!==S.h1&&(s+="/"),e=0,a+=8)}let i="";this._castling[M]&C.KSIDE_CASTLE&&(i+="K"),this._castling[M]&C.QSIDE_CASTLE&&(i+="Q"),this._castling[D]&C.KSIDE_CASTLE&&(i+="k"),this._castling[D]&C.QSIDE_CASTLE&&(i+="q"),i=i||"-";let r="-";if(this._epSquare!==x)if(t)r=P(this._epSquare);else{const a=this._epSquare+(this._turn===M?16:-16),h=[a+1,a-1];for(const u of h){if(u&136)continue;const p=this._turn;if(this._board[u]?.color===p&&this._board[u]?.type===I){this._makeMove({color:p,from:u,to:this._epSquare,piece:I,captured:I,flags:C.EP_CAPTURE});const _=!this._isKingAttacked(p);if(this._undoMove(),_){r=P(this._epSquare);break}}}}return[s,this._turn,i,r,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:e,type:s}=this._board[t],i={w:0,b:1}[e],r={p:0,n:1,b:2,r:3,q:4,k:5}[s];return ls[i][r][t]}_epKey(){return this._epSquare===x?0n:cs[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return fs[t]}_computeHash(){let t=0n;for(let e=S.a8;e<=S.h1;e++){if(e&136){e+=7;continue}this._board[e]&&(t^=this._pieceKey(e))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=me),t}_updateSetup(t){this._history.length>0||(t!==be?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(be)}get(t){return this._board[S[t]]}findPiece(t){const e=[];for(let s=S.a8;s<=S.h1;s++){if(s&136){s+=7;continue}!this._board[s]||this._board[s]?.color!==t.color||this._board[s].color===t.color&&this._board[s].type===t.type&&e.push(P(s))}return e}put({type:t,color:e},s){return this._put({type:t,color:e},s)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,e){this._hash^=this._pieceKey(t),this._board[t]=e,this._hash^=this._pieceKey(t)}_put({type:t,color:e},s){if(_s.indexOf(t.toLowerCase())===-1||!(s in S))return!1;const i=S[s];if(t==T&&!(this._kings[e]==x||this._kings[e]==i))return!1;const r=this._board[i];return r&&r.type===T&&(this._kings[r.color]=x),this._set(i,{type:t,color:e}),t===T&&(this._kings[e]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const e=this.get(t);return this._clear(S[t]),e&&e.type===T&&(this._kings[e.color]=x),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),e}_updateCastlingRights(){this._hash^=this._castlingKey();const t=this._board[S.e1]?.type===T&&this._board[S.e1]?.color===M,e=this._board[S.e8]?.type===T&&this._board[S.e8]?.color===D;(!t||this._board[S.a1]?.type!==te||this._board[S.a1]?.color!==M)&&(this._castling.w&=-65),(!t||this._board[S.h1]?.type!==te||this._board[S.h1]?.color!==M)&&(this._castling.w&=-33),(!e||this._board[S.a8]?.type!==te||this._board[S.a8]?.color!==D)&&(this._castling.b&=-65),(!e||this._board[S.h8]?.type!==te||this._board[S.h8]?.color!==D)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===x)return;const t=this._epSquare+(this._turn===M?-16:16),e=this._epSquare+(this._turn===M?16:-16),s=[e+1,e-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[e]?.color!==ee(this._turn)||this._board[e]?.type!==I){this._hash^=this._epKey(),this._epSquare=x;return}const i=r=>!(r&136)&&this._board[r]?.color===this._turn&&this._board[r]?.type===I;s.some(i)||(this._hash^=this._epKey(),this._epSquare=x)}_attacked(t,e,s){const i=[];for(let r=S.a8;r<=S.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==t)continue;const a=this._board[r],h=r-e;if(h===0)continue;const u=h+119;if(ps[u]&gs[a.type]){if(a.type===I){if(h>0&&a.color===M||h<=0&&a.color===D)if(s)i.push(P(r));else return!0;continue}if(a.type==="n"||a.type==="k")if(s){i.push(P(r));continue}else return!0;const p=ds[u];let _=r+p,E=!1;for(;_!==e;){if(this._board[_]!=null){E=!0;break}_+=p}if(!E)if(s){i.push(P(r));continue}else return!0}}return s?i:!1}attackers(t,e){return e?this._attacked(e,S[t],!0):this._attacked(this._turn,S[t],!0)}_isKingAttacked(t){const e=this._kings[t];return e===-1?!1:this._attacked(ee(t),e)}hash(){return this._hash.toString(16)}isAttacked(t,e){return this._attacked(e,S[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},e=[];let s=0,i=0;for(let r=S.a8;r<=S.h1;r++){if(i=(i+1)%2,r&136){r+=7;continue}const a=this._board[r];a&&(t[a.type]=a.type in t?t[a.type]+1:1,a.type===fe&&e.push(i),s++)}if(s===2)return!0;if(s===3&&(t[fe]===1||t[Ce]===1))return!0;if(s===t[fe]+2){let r=0;const a=e.length;for(let h=0;h<a;h++)r+=e[h];if(r===0||r===a)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:e=void 0,piece:s=void 0}={}){const i=this._moves({square:e,piece:s});return t?i.map(r=>new ae(this,r)):i.map(r=>this._moveToSan(r,i))}_moves({legal:t=!0,piece:e=void 0,square:s=void 0}={}){const i=s?s.toLowerCase():void 0,r=e?.toLowerCase(),a=[],h=this._turn,u=ee(h);let p=S.a8,_=S.h1,E=!1;if(i)if(i in S)p=_=S[i],E=!0;else return[];for(let m=p;m<=_;m++){if(m&136){m+=7;continue}if(!this._board[m]||this._board[m].color===u)continue;const{type:k}=this._board[m];let w;if(k===I){if(r&&r!==k)continue;w=m+ve[h][0],this._board[w]||(H(a,h,m,w,I),w=m+ve[h][1],Es[h]===Y(m)&&!this._board[w]&&H(a,h,m,w,I,void 0,C.BIG_PAWN));for(let L=2;L<4;L++)w=m+ve[h][L],!(w&136)&&(this._board[w]?.color===u?H(a,h,m,w,I,this._board[w].type,C.CAPTURE):w===this._epSquare&&H(a,h,m,w,I,I,C.EP_CAPTURE))}else{if(r&&r!==k)continue;for(let L=0,O=Ye[k].length;L<O;L++){const $=Ye[k][L];for(w=m;w+=$,!(w&136);){if(!this._board[w])H(a,h,m,w,k);else{if(this._board[w].color===h)break;H(a,h,m,w,k,this._board[w].type,C.CAPTURE);break}if(k===Ce||k===T)break}}}}if((r===void 0||r===T)&&(!E||_===this._kings[h])){if(this._castling[h]&C.KSIDE_CASTLE){const m=this._kings[h],k=m+2;!this._board[m+1]&&!this._board[k]&&!this._attacked(u,this._kings[h])&&!this._attacked(u,m+1)&&!this._attacked(u,k)&&H(a,h,this._kings[h],k,T,void 0,C.KSIDE_CASTLE)}if(this._castling[h]&C.QSIDE_CASTLE){const m=this._kings[h],k=m-2;!this._board[m-1]&&!this._board[m-2]&&!this._board[m-3]&&!this._attacked(u,this._kings[h])&&!this._attacked(u,m-1)&&!this._attacked(u,k)&&H(a,h,this._kings[h],k,T,void 0,C.QSIDE_CASTLE)}}if(!t||this._kings[h]===-1)return a;const d=[];for(let m=0,k=a.length;m<k;m++)this._makeMove(a[m]),this._isKingAttacked(h)||d.push(a[m]),this._undoMove();return d}move(t,{strict:e=!1}={}){let s=null;if(typeof t=="string")s=this._moveFromSan(t,e);else if(t===null)s=this._moveFromSan(ye,e);else if(typeof t=="object"){const r=this._moves();for(let a=0,h=r.length;a<h;a++)if(t.from===P(r[a].from)&&t.to===P(r[a].to)&&(!("promotion"in r[a])||t.promotion===r[a].promotion)){s=r[a];break}}if(!s)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&s.flags&C.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new ae(this,s);return this._makeMove(s),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,e){this._hash^=this._pieceKey(t),this._board[e]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(e)}_makeMove(t){const e=this._turn,s=ee(e);if(this._push(t),t.flags&C.NULL_MOVE){e===D&&this._moveNumber++,this._halfMoves++,this._turn=s,this._epSquare=x;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&C.EP_CAPTURE&&(this._turn===D?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:e})),this._board[t.to].type===T){if(this._kings[e]=t.to,t.flags&C.KSIDE_CASTLE){const i=t.to-1,r=t.to+1;this._movePiece(r,i)}else if(t.flags&C.QSIDE_CASTLE){const i=t.to+1,r=t.to-2;this._movePiece(r,i)}this._castling[e]=0}if(this._castling[e]){for(let i=0,r=Q[e].length;i<r;i++)if(t.from===Q[e][i].square&&this._castling[e]&Q[e][i].flag){this._castling[e]^=Q[e][i].flag;break}}if(this._castling[s]){for(let i=0,r=Q[s].length;i<r;i++)if(t.to===Q[s][i].square&&this._castling[s]&Q[s][i].flag){this._castling[s]^=Q[s][i].flag;break}}if(this._hash^=this._castlingKey(),t.flags&C.BIG_PAWN){let i;e===D?i=t.to-16:i=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===I&&this._board[t.to-1]?.color===s||!(t.to+1&136)&&this._board[t.to+1]?.type===I&&this._board[t.to+1]?.color===s?(this._epSquare=i,this._hash^=this._epKey()):this._epSquare=x}else this._epSquare=x;t.piece===I?this._halfMoves=0:t.flags&(C.CAPTURE|C.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,e===D&&this._moveNumber++,this._turn=s,this._hash^=me}undo(){const t=this._hash,e=this._undoMove();if(e){const s=new ae(this,e);return this._decPositionCount(t),s}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const e=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=me;const s=this._turn,i=ee(s);if(e.flags&C.NULL_MOVE)return e;if(this._movePiece(e.to,e.from),e.piece&&(this._clear(e.from),this._set(e.from,{type:e.piece,color:s})),e.captured)if(e.flags&C.EP_CAPTURE){let r;s===D?r=e.to-16:r=e.to+16,this._set(r,{type:I,color:i})}else this._set(e.to,{type:e.captured,color:i});if(e.flags&(C.KSIDE_CASTLE|C.QSIDE_CASTLE)){let r,a;e.flags&C.KSIDE_CASTLE?(r=e.to+1,a=e.to-1):(r=e.to-2,a=e.to+1),this._movePiece(a,r)}return e}pgn({newline:t=`
`,maxWidth:e=0}={}){const s=[];let i=!1;for(const d in this._header)this._header[d]&&s.push(`[${d} "${this._header[d]}"]`+t),i=!0;i&&this._history.length&&s.push(t);const r=d=>{const m=this._comments[this.fen()];if(typeof m<"u"){const k=d.length>0?" ":"";d=`${d}${k}{${m}}`}return d},a=[];for(;this._history.length>0;)a.push(this._undoMove());const h=[];let u="";for(a.length===0&&h.push(r(""));a.length>0;){u=r(u);const d=a.pop();if(!d)break;if(!this._history.length&&d.color==="b"){const m=`${this._moveNumber}. ...`;u=u?`${u} ${m}`:m}else d.color==="w"&&(u.length&&h.push(u),u=this._moveNumber+".");u=u+" "+this._moveToSan(d,this._moves({legal:!0})),this._makeMove(d)}if(u.length&&h.push(r(u)),h.push(this._header.Result||"*"),e===0)return s.join("")+h.join(" ");const p=function(){return s.length>0&&s[s.length-1]===" "?(s.pop(),!0):!1},_=function(d,m){for(const k of m.split(" "))if(k){if(d+k.length>e){for(;p();)d--;s.push(t),d=0}s.push(k),d+=k.length,s.push(" "),d++}return p()&&d--,d};let E=0;for(let d=0;d<h.length;d++){if(E+h[d].length>e&&h[d].includes("{")){E=_(E,h[d]);continue}E+h[d].length>e&&d!==0?(s[s.length-1]===" "&&s.pop(),s.push(t),E=0):d!==0&&(s.push(" "),E++),s.push(h[d]),E+=h[d].length}return s.join("")}header(...t){for(let e=0;e<t.length;e+=2)typeof t[e]=="string"&&typeof t[e+1]=="string"&&(this._header[t[e]]=t[e+1]);return this._header}setHeader(t,e){return this._header[t]=e??ke[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=ke[t]||null,!0):!1}getHeaders(){const t={};for(const[e,s]of Object.entries(this._header))s!==null&&(t[e]=s);return t}loadPgn(t,{strict:e=!1,newlineChar:s=`\r?
`}={}){s!==`\r?
`&&(t=t.replace(new RegExp(s,"g"),`
`));const i=os(t);this.reset();const r=i.headers;let a="";for(const p in r)p.toLowerCase()==="fen"&&(a=r[p]),this.header(p,r[p]);if(!e)a&&this.load(a,{preserveHeaders:!0});else if(r.SetUp==="1"){if(!("FEN"in r))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(r.FEN,{preserveHeaders:!0})}let h=i.root;for(;h;){if(h.move){const p=this._moveFromSan(h.move,e);if(p==null)throw new Error(`Invalid move in PGN: ${h.move}`);this._makeMove(p),this._incPositionCount()}h.comment!==void 0&&(this._comments[this.fen()]=h.comment),h=h.variations[0]}const u=i.result;u&&Object.keys(this._header).length&&this._header.Result!==u&&this.setHeader("Result",u)}_moveToSan(t,e){let s="";if(t.flags&C.KSIDE_CASTLE)s="O-O";else if(t.flags&C.QSIDE_CASTLE)s="O-O-O";else{if(t.flags&C.NULL_MOVE)return ye;if(t.piece!==I){const i=Cs(t,e);s+=t.piece.toUpperCase()+i}t.flags&(C.CAPTURE|C.EP_CAPTURE)&&(t.piece===I&&(s+=P(t.from)[0]),s+="x"),s+=P(t.to),t.promotion&&(s+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?s+="#":s+="+"),this._undoMove(),s}_moveFromSan(t,e=!1){let s=Ee(t);if(e||(s==="0-0"?s="O-O":s==="0-0-0"&&(s="O-O-O")),s==ye)return{color:this._turn,from:0,to:0,piece:"k",flags:C.NULL_MOVE};let i=ze(s),r=this._moves({legal:!0,piece:i});for(let d=0,m=r.length;d<m;d++)if(s===Ee(this._moveToSan(r[d],r)))return r[d];if(e)return null;let a,h,u,p,_,E=!1;if(h=s.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),h?(a=h[1],u=h[2],p=h[3],_=h[4],u.length==1&&(E=!0)):(h=s.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),h&&(a=h[1],u=h[2],p=h[3],_=h[4],u.length==1&&(E=!0))),i=ze(s),r=this._moves({legal:!0,piece:a||i}),!p)return null;for(let d=0,m=r.length;d<m;d++)if(u){if((!a||a.toLowerCase()==r[d].piece)&&S[u]==r[d].from&&S[p]==r[d].to&&(!_||_.toLowerCase()==r[d].promotion))return r[d];if(E){const k=P(r[d].from);if((!a||a.toLowerCase()==r[d].piece)&&S[p]==r[d].to&&(u==k[0]||u==k[1])&&(!_||_.toLowerCase()==r[d].promotion))return r[d]}}else if(s===Ee(this._moveToSan(r[d],r)).replace("x",""))return r[d];return null}ascii(){let t=`   +------------------------+
`;for(let e=S.a8;e<=S.h1;e++){if(se(e)===0&&(t+=" "+"87654321"[Y(e)]+" |"),this._board[e]){const s=this._board[e].type,r=this._board[e].color===M?s.toUpperCase():s.toLowerCase();t+=" "+r+" "}else t+=" . ";e+1&136&&(t+=`|
`,e+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const e=this._moves({legal:!1});let s=0;const i=this._turn;for(let r=0,a=e.length;r<a;r++)this._makeMove(e[r]),this._isKingAttacked(i)||(t-1>0?s+=this.perft(t-1):s++),this._undoMove();return s}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let e=[];for(let s=S.a8;s<=S.h1;s++)this._board[s]==null?e.push(null):e.push({square:P(s),type:this._board[s].type,color:this._board[s].color}),s+1&136&&(t.push(e),e=[],s+=8);return t}squareColor(t){if(t in S){const e=S[t];return(Y(e)+se(e))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const e=[],s=[];for(;this._history.length>0;)e.push(this._undoMove());for(;;){const i=e.pop();if(!i)break;t?s.push(new ae(this,i)):s.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return s}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const e=this._positionCount.get(t)??0;e===1?this._positionCount.delete(t):this._positionCount.set(t,e-1)}_pruneComments(){const t=[],e={},s=i=>{i in this._comments&&(e[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(s(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),s(this.fen())}this._comments=e}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const e=this._comments[t];return delete this._comments[t],{fen:t,comment:e}})}setCastlingRights(t,e){for(const i of[T,W])e[i]!==void 0&&(e[i]?this._castling[t]|=le[i]:this._castling[t]&=~le[i]);this._updateCastlingRights();const s=this.getCastlingRights(t);return(e[T]===void 0||e[T]===s[T])&&(e[W]===void 0||e[W]===s[W])}getCastlingRights(t){return{[T]:(this._castling[t]&le[T])!==0,[W]:(this._castling[t]&le[W])!==0}}moveNumber(){return this._moveNumber}}async function $s(n,t){const e=new Worker("./stockfish.js"),s=new ks;s.loadPgn(n,{strict:!1});let i=0;const r=s.history({verbose:!0});let a=s.fen();for(let h=0;h<r.length;h++){const p=(h+1)%2===1;if(t==="white"&&!p||t==="black"&&p){s.move(r[h]),a=s.fen();continue}const _=s.fen();s.move(r[h]);const E=await Ze(e,a),d=await Ze(e,_);(t==="white"?d-E:E-d)<-500&&i++}return e.terminate(),i}async function Ze(n,t){return new Promise(e=>{let s=null;n.onmessage=i=>{const r=i.data;if(typeof r!="string")return;const a=r.match(/score cp (-?\d+)/);a&&(s=parseInt(a[1]));const h=r.match(/score mate (-?\d+)/);h&&(s=parseInt(h[1])>0?1e4:-1e4),r.startsWith("bestmove")&&e(s!==null?s:0)},n.postMessage(`position fen ${t}`),n.postMessage("go depth 8")})}function Se(n){const t=document.getElementById("loading"),e=document.getElementById("stats"),s=document.getElementById("graphs-container");t&&(t.style.display=n?"flex":"none",s.style.display=n?"none":"flex",e.style.display=n?"none":"flex")}async function As(n){const t=n.length;let e=0,s=0,i=0,r=0,a=0,h=0,u=0,p=0,_=0,E=0,d=0,m=0;if(t===0)return null;const k=n[0].kris_rating,L=n[n.length-1].kris_rating-k;n.forEach($=>{$.kris_result==="win"?(e++,$.opp_result==="resigned"&&u++,$.opp_result==="checkmated"&&p++,$.opp_result==="timeout"&&_++,$.opp_result==="abandoned"&&E++):$.kris_result==="repetition"||$.kris_result==="agreed"||$.kris_result==="stalemate"||$.kris_result==="insufficient"||$.kris_result==="timevsinsufficient"?s++:$.opp_result==="win"&&(i++,$.kris_result==="resigned"&&d++,$.kris_result==="checkmated"&&m++,$.kris_result==="timeout"&&r++,$.kris_result==="abandoned"&&a++)});for(const $ of n){const q=await $s($.pgn_results,$.kris_color);h+=q}const O=(e/t*100).toFixed(2);return{num_games:t,wins:e,draws:s,losses:i,timeouts:r,abandoned:a,opp_resigned:u,opp_checkmated:p,opp_timeout:_,opp_abandoned:E,resigned:d,checkmated:m,win_rate:O,elo_change:L,tot_blunders:h}}function ws(n,t,e){if(!n)return;console.log("blunders:",n.tot_blunders);const s=[n.opp_resigned>0?`${n.opp_resigned} resignations`:null,n.opp_checkmated>0?`${n.opp_checkmated} checkmates`:null,n.opp_timeout>0?`${n.opp_timeout} timeouts`:null,n.opp_abandoned>0?`${n.opp_abandoned} abandoned`:null].filter(Boolean).join(", "),i=[n.resigned>0?`${n.resigned} resignations`:null,n.checkmated>0?`${n.checkmated} checkmates`:null,n.timeouts>0?`${n.timeouts} timeouts`:null,n.abandoned>0?`${n.abandoned} abandoned`:null].filter(Boolean).join(", "),r=[n.draws>0?`, drew ${n.draws} games`:null].filter(Boolean).join(", ");document.getElementById("stats").innerHTML=`
    <p id="games-played">${e} played ${n.num_games} games in ${t}.</p>
  <p id="wins-losses">They won ${n.wins} games (${s}) ${r} and lost ${n.losses} games (${i}).</p>
  <p id="win-rate">That's a win rate of ${n.win_rate}%.</p>
  <p id="elo-change">Their ELO change over the month was: ${n.elo_change}</p>`}async function Is(n,t,e){try{const s=await fetch(`https://blunderstruck.onrender.com/api/month/?username=${n}&month=${t}&year=${e}`);if(console.log("Fetch status:",s.status),s.status===404)return{error:"user doesn't exist"};if(s.status===200)return{message:"found user"}}catch(s){return console.error("Error in fetchRecentMonths:",s),[]}}async function Ts(n,t,e){try{const s=await fetch(`https://blunderstruck.onrender.com/api/month/?username=${n}&month=${t}&year=${e}`);if(console.log("Fetch status:",s.status),!s.ok)return console.warn("Non-OK response from server"),[];const i=await s.json();if(!i||!Array.isArray(i.games))return console.warn("No valid games array found in response:",i),[];const r=i.games.flatMap(a=>Array.isArray(a)?a:[a]);return console.log("Flattened games:",r.length),r}catch(s){return console.error("Error in fetchRecentMonths:",s),[]}}function Ns(n,t){const e=n.white.username.toLowerCase()===t,s=e?n.white:n.black,i=e?n.black:n.white,r=new Date(n.end_time*1e3);let a="";if(n.eco){const h=n.eco,p=(e?h.split("/").pop():"").replace(/-/g," ").replace(/\d+\./g,"").trim(),_=p.split(" ");_.length>4?a=_.slice(0,4).join(" ")+"...":a=p}return{chesscom_id:n.url?.split("/").pop()||null,date:r,dateStr:r.toISOString().slice(0,10),end_time:n.end_time,time_control:n.time_control,kris_color:e?"white":"black",kris_rating:s.rating,opp_rating:i.rating,kris_result:s.result,opp_result:i.result,opening:a,pgn_results:n.pgn||null}}function Ps(n){const t={};for(const u of n)t[u.dateStr]=u.kris_rating;const e=[],s=[],i=new Date(n[0].dateStr),r=new Date(n[n.length-1].dateStr);for(let u=new Date(i);u<=r;u.setDate(u.getDate()+1)){const p=u.toISOString().slice(0,10),_=p in t?t[p]:null;e.push(p),s.push(_)}let a=null;const h=s.map(u=>u!=null?(a=u,u):a);return{days:e,ratings:h}}function xs(n){const{days:t,ratings:e}=Ps(n),s=["January","February","March","April","May","June","July","August","September","October","November","December"],i=document.getElementById("ratingChart"),r={labels:t,datasets:[{label:"Rating Over Time",data:e,borderColor:"rgba(54, 162, 235, 1)",borderWidth:2,tension:.3,fill:!1,pointRadius:3}]},a={scales:{x:{title:{display:!0,text:(()=>{if(t.length>0){const h=new Date(t[0]);return`${s[h.getMonth()]} ${h.getFullYear()}`}return""})(),font:{size:14}},ticks:{callback:function(h,u){return new Date(t[u]).getDate()}}},y:{beginAtZero:!1,title:{display:!0,text:"ELO",font:{size:20}}}},plugins:{legend:{display:!1,position:"bottom"}}};return new Chart(i,{type:"line",data:r,options:a})}function Os(n){const t={};n.forEach(s=>{s.opening&&(t[s.opening]=(t[s.opening]||0)+1)});let e=0;n.length>100?e=5:e=2;for(const s in t)t[s]<e&&delete t[s];return t}function Ms(n){const t=Os(n),e=Object.keys(t),s=Object.values(t),i=document.getElementById("openingsChart").getContext("2d"),r={labels:e,datasets:[{label:"Times Played",data:s,backgroundColor:"rgba(54, 162, 235, 0.5)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1}]},a={indexAxis:"y",scales:{x:{title:{display:!0,text:"Number of Games"},beginAtZero:!0},y:{title:{display:!0,text:"Opening"}}},plugins:{legend:{display:!1}}};return new Chart(i,{type:"bar",data:r,options:a})}async function Ls(n){const t=document.getElementById("stats"),e=document.getElementById("graphs-container");t.style.display="none",e.style.display="none",document.getElementById("stats").innerHTML="";const s=document.getElementById("controls");n=document.getElementById("usernameInput").value.trim();const a=new Date().getFullYear(),h=new Date().getMonth()+1;console.log("Username set:",n);const u=document.getElementById("message");u.style.display="none";const p=document.getElementById("no-user-message");if(p.style.display="none",(await Is(n,h,a)).error){p.style.display="block";return}s.style.display="inline-block";const E=document.getElementById("yearSelect"),d=document.getElementById("monthSelect"),m=document.getElementById("loadButton");if(document.querySelectorAll("option").length<1){for(let O=a;O>=2020;O--){const $=document.createElement("option");$.value=O,$.textContent=O,E.appendChild($)}["January","February","March","April","May","June","July","August","September","October","November","December"].forEach((O,$)=>{const q=document.createElement("option");q.value=$+1,q.textContent=O,d.appendChild(q)})}E.value=a,d.value=h;const w=m.cloneNode(!0);m.parentNode.replaceChild(w,m),w.addEventListener("click",async()=>{const L=E.value,O=d.value;console.log("fetching for",n),console.log(O),Se(!0);try{const $=await Ts(n,O,L);console.log("Fetched raw data:",$.length);const q=($||[]).filter(B=>B.rated===!0);console.log("Found rated games:",q.length);const j=q.map(B=>Ns(B,n)).sort((B,J)=>B.end_time-J.end_time);if(console.log("Normalised games:",j.length),Se(!1),!j||j.length===0)e.style.display="none",document.getElementById("stats").innerHTML="<p>Sorry, no games found for this month. Please select a different month.</p>",console.log("no games found for this month");else{e.style.display="flex";const B=new Date(L,O-1).toLocaleString("default",{month:"long"}),J=As(j);ws(J,B,n),window.eloChartInstance&&window.eloChartInstance.destroy(),window.openingsChartInstance&&window.openingsChartInstance.destroy(),window.eloChartInstance=xs(j),window.openingsChartInstance=Ms(j)}}catch($){return console.error("Error in deploying:",$),Se(!1),[]}}),w.click()}document.addEventListener("DOMContentLoaded",async()=>{console.log("DOMContentLoaded fired âœ…");let n=null;const t=document.getElementById("search-button"),e=document.getElementById("usernameInput"),s=document.getElementById("message"),i=document.getElementById("stats");document.querySelectorAll(".hidden-on-load").forEach(a=>a.style.display="none"),i.style.display="none",s.style.display="block",t.addEventListener("click",async()=>{t.disabled=!0,t.style.display="none",await Ls(n)}),e.addEventListener("focus",async()=>{t.disabled=!1,t.style.display="inline-block"})});
